{% extends "dashboard/dashboard_base.html" %}

{% block title %}Broker Management - tCapital{% endblock %}
{% block dashboard_title %}Broker Management{% endblock %}
{% block dashboard_subtitle %}Connect and manage your trading accounts across multiple brokers{% endblock %}

{% block dashboard_toolbar %}
<div class="header-actions">
    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
        <i class="fas fa-sync-alt me-1"></i>
        Refresh
    </button>
</div>
{% endblock %}

{% block dashboard_content %}

<!-- All Brokers List -->
<div class="card shadow-sm">
    <div class="card-header bg-white border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-building me-2"></i>All Supported Brokers</h5>
            <small class="text-muted">
                <span class="badge bg-success">5 Active</span>
                <span class="badge bg-secondary ms-2">7 Coming Soon</span>
            </small>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 broker-table">
                <thead class="table-light">
                    <tr>
                        <th width="40%">Broker</th>
                        <th width="15%" class="text-center">Status</th>
                        <th width="15%" class="text-center">Connection</th>
                        <th width="30%" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for broker in broker_catalog %}
                    <tr class="broker-row {% if broker.account and broker.account.is_primary %}table-primary{% endif %}">
                        <!-- Broker Name & Logo -->
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="broker-icon me-3">
                                    <i class="fas fa-building text-primary"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">
                                        {{ broker.name }}
                                        {% if broker.account and broker.account.is_primary %}
                                        <span class="badge bg-primary ms-2">P</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ broker.description }}</small>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Broker Status (Active/Coming Soon) -->
                        <td class="text-center">
                            {% if broker.status == 'active' %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Coming Soon</span>
                            {% endif %}
                        </td>
                        
                        <!-- Connection Status -->
                        <td class="text-center">
                            {% if broker.account %}
                                {% if broker.account.connection_status == 'connected' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Connected
                                </span>
                                {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-circle me-1"></i>Disconnected
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-minus-circle me-1"></i>Not Added
                            </span>
                            {% endif %}
                        </td>
                        
                        <!-- Action Buttons -->
                        <td class="text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                {% if broker.status == 'active' %}
                                    {% if broker.account %}
                                        <!-- Edit & Details buttons for added brokers -->
                                        <button class="btn btn-outline-secondary" 
                                                onclick="editBroker('{{ broker.type.value }}', '{{ broker.name }}', {{ broker.account.id }})"
                                                title="Edit Credentials">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        
                                        <!-- Connect/Disconnect toggle -->
                                        {% if broker.account.connection_status == 'connected' %}
                                        <button class="btn btn-outline-warning" 
                                                onclick="disconnectBroker({{ broker.account.id }})"
                                                title="Disconnect Broker">
                                            <i class="fas fa-unlink"></i> Disconnect
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-success" 
                                                onclick="connectBroker({{ broker.account.id }})"
                                                title="Connect Broker">
                                            <i class="fas fa-link"></i> Connect
                                        </button>
                                        {% endif %}
                                        
                                        <!-- Set Primary (only for connected non-primary) -->
                                        {% if broker.account.connection_status == 'connected' and not broker.account.is_primary %}
                                        <button class="btn btn-outline-primary" 
                                                onclick="setPrimaryBroker({{ broker.account.id }})"
                                                title="Set as Primary">
                                            <i class="fas fa-star"></i> Primary
                                        </button>
                                        {% endif %}
                                    {% else %}
                                        <!-- Add button for brokers not yet added -->
                                        <button class="btn btn-outline-primary" 
                                                onclick="showAddBrokerForm('{{ broker.type.value }}', '{{ broker.name }}')"
                                                title="Add Broker">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <!-- Coming Soon brokers -->
                                    <button class="btn btn-outline-secondary" disabled>
                                        <i class="fas fa-clock"></i> Coming Soon
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Broker Form Section (Inline) -->
<div class="card shadow-sm mt-4" id="addBrokerSection" style="display: none;">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-plus-circle me-2"></i>
                <span id="formTitle">Add Broker Account</span>
            </h5>
            <button type="button" class="btn btn-sm btn-light" onclick="hideAddBrokerForm()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
    <div class="card-body">
        <form id="addBrokerForm">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="brokerType" class="form-label">Select Broker <span class="text-danger">*</span></label>
                    <select class="form-control" id="brokerType" name="broker_type" required>
                        <option value="">Choose a broker...</option>
                        <optgroup label="âœ… Available Now">
                            <option value="dhan">Dhan (Free APIs)</option>
                            <option value="zerodha">Zerodha Kite Connect (â‚¹500/month)</option>
                            <option value="angel_broking">Angel One SmartAPI (Free)</option>
                            <option value="groww">Groww (REST API)</option>
                            <option value="upstox">Upstox (Official SDK)</option>
                        </optgroup>
                        <optgroup label="ðŸ”œ Coming Soon">
                            <option value="" disabled>FYERS - Coming Soon</option>
                            <option value="" disabled>ICICI Direct - Coming Soon</option>
                            <option value="" disabled>HDFC Securities - Coming Soon</option>
                            <option value="" disabled>Kotak Securities - Coming Soon</option>
                            <option value="" disabled>5Paisa - Coming Soon</option>
                            <option value="" disabled>Choice India - Coming Soon</option>
                            <option value="" disabled>Goodwill - Coming Soon</option>
                        </optgroup>
                    </select>
                    <small class="form-text text-muted mt-2 d-block">
                        <i class="fas fa-info-circle me-1"></i>Currently supporting 5 major Indian brokers. More brokers will be added soon!
                    </small>
                </div>
            </div>
            
            <!-- Dhan Credentials -->
            <div id="dhanCredentials" style="display: none;">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Get Your Dhan API Credentials</h6>
                    <ol class="mb-0">
                        <li>Login to <a href="https://web.dhan.co" target="_blank">web.dhan.co</a></li>
                        <li>Go to Profile â†’ "DhanHQ Trading APIs"</li>
                        <li>Request access if first time, then generate your access token</li>
                        <li>Copy your Client ID and Access Token below</li>
                    </ol>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="dhanClientId" class="form-label">Client ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="dhanClientId" name="client_id" placeholder="Your Dhan Client ID">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="dhanAccessToken" class="form-label">Access Token <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="dhanAccessToken" name="access_token" placeholder="Your Dhan Access Token">
                    </div>
                </div>
                <small class="form-text text-muted d-block mb-3">Your credentials are encrypted and stored securely</small>
            </div>
            
            <!-- Zerodha Credentials -->
            <div id="zerodhaCredentials" style="display: none;">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Get Your Zerodha Kite Connect API Credentials</h6>
                    <ol class="mb-0">
                        <li>Go to <a href="https://developers.kite.trade" target="_blank">developers.kite.trade</a></li>
                        <li>Login with your Zerodha credentials and create an app</li>
                        <li>Get your API Key and API Secret</li>
                        <li>Generate access token using the login flow</li>
                        <li><strong>Note:</strong> Kite Connect costs â‚¹500/month</li>
                    </ol>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="zerodhaApiKey" class="form-label">API Key <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="zerodhaApiKey" name="client_id" placeholder="Your Zerodha API Key">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="zerodhaAccessToken" class="form-label">Access Token <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="zerodhaAccessToken" name="access_token" placeholder="Your Zerodha Access Token">
                    </div>
                </div>
                <small class="form-text text-muted d-block mb-3">Generate this through Zerodha login flow</small>
            </div>
            
            <!-- Angel One Credentials -->
            <div id="angelCredentials" style="display: none;">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Get Your Angel One SmartAPI Credentials</h6>
                    <ol class="mb-0">
                        <li>Go to <a href="https://smartapi.angelone.in" target="_blank">smartapi.angelone.in</a></li>
                        <li>Register with your Angel One client details</li>
                        <li>Generate API Key and enable TOTP</li>
                        <li>Use your client code and trading PIN below</li>
                    </ol>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="angelApiKey" class="form-label">API Key <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="angelApiKey" name="client_id" placeholder="Your Angel One API Key">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="angelClientCode" class="form-label">Client Code <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="angelClientCode" name="access_token" placeholder="Your Angel One Client Code">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="angelPin" class="form-label">Trading PIN <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="angelPin" name="api_secret" placeholder="Your Angel One Trading PIN">
                    </div>
                </div>
                <small class="form-text text-muted d-block mb-3">Your trading PIN (not login password)</small>
            </div>
            
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" onclick="hideAddBrokerForm()">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitBrokerForm()">
                    <i class="fas fa-save me-2"></i><span id="submitButtonText">Add Broker</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Show Add Broker Form (inline, not modal)
function showAddBrokerForm(brokerType, brokerName) {
    // Set form title and button text
    document.getElementById('formTitle').textContent = `Add ${brokerName} Account`;
    document.getElementById('submitButtonText').textContent = 'Add Broker';
    
    // Reset and set broker type
    document.getElementById('addBrokerForm').reset();
    document.getElementById('brokerType').value = brokerType;
    document.getElementById('brokerType').removeAttribute('data-account-id');
    
    // Trigger change event to show appropriate credentials form
    document.getElementById('brokerType').dispatchEvent(new Event('change'));
    
    // Show the form section
    document.getElementById('addBrokerSection').style.display = 'block';
    
    // Scroll to the form smoothly
    setTimeout(() => {
        document.getElementById('addBrokerSection').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 100);
}

// Hide Add Broker Form
function hideAddBrokerForm() {
    document.getElementById('addBrokerSection').style.display = 'none';
    document.getElementById('addBrokerForm').reset();
    
    // Hide all credential forms
    document.getElementById('dhanCredentials').style.display = 'none';
    document.getElementById('zerodhaCredentials').style.display = 'none';
    document.getElementById('angelCredentials').style.display = 'none';
}

// Edit existing broker
function editBroker(brokerType, brokerName, accountId) {
    // Set form title and button text
    document.getElementById('formTitle').textContent = `Edit ${brokerName} Credentials`;
    document.getElementById('submitButtonText').textContent = 'Update Credentials';
    
    // Set broker type and account ID
    document.getElementById('brokerType').value = brokerType;
    document.getElementById('brokerType').setAttribute('data-account-id', accountId);
    
    // Trigger change event to show appropriate credentials form
    document.getElementById('brokerType').dispatchEvent(new Event('change'));
    
    // Show the form section
    document.getElementById('addBrokerSection').style.display = 'block';
    
    // Scroll to the form smoothly
    setTimeout(() => {
        document.getElementById('addBrokerSection').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 100);
}

// Submit broker form (Add or Edit)
function submitBrokerForm() {
    const form = document.getElementById('addBrokerForm');
    const formData = new FormData(form);
    
    const data = {
        broker_type: formData.get('broker_type'),
        client_id: formData.get('client_id'),
        access_token: formData.get('access_token'),
        api_secret: formData.get('api_secret') || null,
        totp_secret: formData.get('totp_secret') || null
    };
    
    // Validate
    if (!data.broker_type || !data.client_id || !data.access_token) {
        alert('Please fill in all required fields');
        return;
    }
    
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    
    fetch('/api/broker/add-account', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save broker. Please try again.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Connect broker (Step 2: Activate)
function connectBroker(accountId) {
    if (!confirm('Connect this broker? This will activate it for trading.')) return;
    
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
    
    fetch(`/api/broker/${accountId}/connect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to connect broker.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Disconnect broker
function disconnectBroker(accountId) {
    if (!confirm('Disconnect this broker? You can reconnect later without re-entering credentials.')) return;
    
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Disconnecting...';
    
    fetch(`/api/broker/${accountId}/disconnect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to disconnect broker.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Set Primary Broker
function setPrimaryBroker(accountId) {
    if (!confirm('Set this as your primary broker for trading?')) return;
    
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting...';
    
    fetch(`/api/broker/set-primary/${accountId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to set primary broker.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Show/hide credentials based on broker selection
document.getElementById('brokerType').addEventListener('change', function() {
    const brokerType = this.value;
    
    // Hide all credential forms
    document.getElementById('dhanCredentials').style.display = 'none';
    document.getElementById('zerodhaCredentials').style.display = 'none';
    document.getElementById('angelCredentials').style.display = 'none';
    
    // Show selected broker credentials
    if (brokerType === 'dhan') {
        document.getElementById('dhanCredentials').style.display = 'block';
    } else if (brokerType === 'zerodha') {
        document.getElementById('zerodhaCredentials').style.display = 'block';
    } else if (brokerType === 'angel_broking') {
        document.getElementById('angelCredentials').style.display = 'block';
    }
});

// Reset form function
function resetForm() {
    document.getElementById('addBrokerForm').reset();
    document.getElementById('dhanCredentials').style.display = 'none';
    document.getElementById('zerodhaCredentials').style.display = 'none';
    document.getElementById('angelCredentials').style.display = 'none';
}

// Add broker account
function addBrokerAccount() {
    const form = document.getElementById('addBrokerForm');
    const formData = new FormData(form);
    
    const data = {
        broker_type: formData.get('broker_type'),
        client_id: formData.get('client_id'),
        access_token: formData.get('access_token'),
        api_secret: formData.get('api_secret') || null
    };
    
    // Validate
    if (!data.broker_type || !data.client_id || !data.access_token) {
        alert('Please fill in all required fields');
        return;
    }
    
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Connecting...';
    
    fetch('/api/broker/add-account', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Connection failed. Please check your credentials and try again.');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Sync account data
function syncAccount(accountId) {
    if (!confirm('Sync latest data from broker?')) return;
    
    fetch(`/api/broker/sync-account/${accountId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Sync failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Sync failed. Please try again.');
    });
}

// Test connection
function testConnection(accountId) {
    fetch(`/api/broker/test-connection/${accountId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Connection successful!');
        } else {
            alert('Connection failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Test failed. Please try again.');
    });
}

// Set as primary broker
function setPrimary(accountId) {
    if (!confirm('Set this as your primary broker for trading?')) return;
    
    fetch(`/api/broker/set-primary/${accountId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to set primary broker.');
    });
}

// Connect account (Step 2: Activate broker)
function connectAccount(accountId) {
    if (!confirm('Connect this broker? This will activate the broker for trading.')) return;
    
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Connecting...';
    
    fetch(`/api/broker/${accountId}/connect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to connect broker.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Disconnect account (Deactivate broker)
function disconnectAccount(accountId) {
    if (!confirm('Disconnect this broker? This will deactivate the broker.')) return;
    
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Disconnecting...';
    
    fetch(`/api/broker/${accountId}/disconnect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to disconnect broker.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

// Remove account
function removeAccount(accountId) {
    if (!confirm('Are you sure you want to remove this broker account? This will delete all associated data.')) return;
    
    fetch(`/api/broker/remove-account/${accountId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove account.');
    });
}
</script>

<style>
.broker-account-card {
    transition: transform 0.2s;
}

.broker-account-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.alert-sm {
    padding: 0.5rem;
    font-size: 0.875rem;
}

/* CRITICAL: Hide Learning Progress widget completely */
.learning-progress-widget,
.progress-widget-container,
.achievement-notification,
.level-up-notification {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
}

/* Ensure modal appears above everything */
#addBrokerModal {
    z-index: 9999 !important;
}

.modal-backdrop {
    z-index: 9998 !important;
}

/* Ensure modal is clickable and not blocked */
.modal-dialog {
    pointer-events: auto !important;
}

.modal-content {
    pointer-events: auto !important;
}
</style>

{% endblock %}
