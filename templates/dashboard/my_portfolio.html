{% extends "dashboard/dashboard_base.html" %}

{% block title %}My Portfolio - tCapital{% endblock %}

{% block dashboard_title %}My Portfolio{% endblock %}
{% block dashboard_subtitle %}
    {% if has_broker_access %}
        Comprehensive portfolio analysis with multi-broker integration
    {% else %}
        Advanced portfolio insights and tracking
    {% endif %}
{% endblock %}

{% block dashboard_content %}

<!-- Portfolio Preferences Alert -->
{% if not current_user.portfolio_preferences or not current_user.portfolio_preferences.completed %}
<div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <div class="d-flex align-items-center">
        <i class="fas fa-info-circle fa-2x me-3"></i>
        <div class="flex-grow-1">
            <h6 class="alert-heading mb-1">Personalize Your Portfolio Experience</h6>
            <p class="mb-2">Set your investment preferences to get personalized recommendations from our AI Research Assistant and Portfolio Optimizer.</p>
            <a href="{{ url_for('portfolio_preferences') }}" class="btn btn-sm btn-primary">
                <i class="fas fa-sliders-h me-1"></i>Set Portfolio Preferences
            </a>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>
{% endif %}

<!-- Portfolio Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient-primary text-white border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Total Value</h6>
                        <h4 class="mb-0">₹{{ "{:,.0f}".format(portfolio_analysis.portfolio_summary.total_value or 0) }}</h4>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient-{{ 'success' if (portfolio_analysis.portfolio_summary.total_pnl or 0) >= 0 else 'danger' }} text-white border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Total P&L</h6>
                        <h4 class="mb-0">
                            {{ '+' if (portfolio_analysis.portfolio_summary.total_pnl or 0) >= 0 else '' }}₹{{ "{:,.0f}".format(portfolio_analysis.portfolio_summary.total_pnl or 0) }}
                        </h4>
                        <small class="opacity-75">
                            {{ '+' if (portfolio_analysis.portfolio_summary.total_pnl_percentage or 0) >= 0 else '' }}{{ "%.2f"|format(portfolio_analysis.portfolio_summary.total_pnl_percentage or 0) }}%
                        </small>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient-info text-white border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Holdings</h6>
                        <h4 class="mb-0">{{ portfolio_analysis.portfolio_summary.holdings_count or 0 }}</h4>
                        <small class="opacity-75">Across {{ portfolio_analysis.portfolio_summary.brokers_count or 0 }} broker{{ 's' if portfolio_analysis.portfolio_summary.brokers_count != 1 else '' }}</small>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card border-0 h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Health Score</h6>
                        <h4 class="mb-0">{{ portfolio_analysis.ai_assessment.health_score or 75 }}/100</h4>
                        <small class="opacity-75">{{ portfolio_analysis.ai_assessment.risk_level or 'Medium' }} Risk</small>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-heartbeat fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Filter Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-3">
                <div class="row align-items-center">
                    <div class="col-md-6 mb-2 mb-md-0">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <label class="mb-0 text-muted small">Filter by:</label>
                            <select class="form-select form-select-sm" id="assetTypeFilter" style="width: auto; min-width: 150px;" onchange="filterByAssetType(this.value)">
                                <option value="all">All Assets</option>
                                <option value="equities">Stocks</option>
                                <option value="mutual_funds">Mutual Funds</option>
                                <option value="etf">ETFs</option>
                                <option value="futures_options">F&O</option>
                                <option value="fixed_income">Bonds</option>
                                <option value="gold">Gold</option>
                                <option value="real_estate">Real Estate</option>
                                <option value="nps">NPS</option>
                                <option value="crypto">Crypto</option>
                            </select>
                            <span class="badge bg-primary" id="filterCount">0 holdings</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-wrap justify-content-md-end gap-2">
                            {% if has_broker_access %}
                            <button class="btn btn-sm btn-primary" onclick="syncBrokerData()">
                                <i class="fas fa-sync me-1"></i>Sync Brokers
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-upload me-1"></i>Upload
                            </button>
                            <a href="{{ url_for('portfolio_risk_profile') }}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-user-check me-1"></i>Risk Profile
                            </a>
                            <a href="{{ url_for('portfolio_preferences') }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-sliders-h me-1"></i>Portfolio Preferences
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights (Collapsible) -->
{% if portfolio_analysis.ai_assessment.suggestions %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 cursor-pointer" data-bs-toggle="collapse" data-bs-target="#aiInsights">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb text-warning me-2"></i>AI Insights & Recommendations
                    </h6>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="collapse show" id="aiInsights">
                <div class="card-body">
                    <div class="row">
                        {% for suggestion in portfolio_analysis.ai_assessment.suggestions[:3] %}
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                <small>{{ suggestion }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Portfolio Holdings Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h6 class="fw-bold mb-0">
                    <i class="fas fa-list me-2"></i>Holdings
                    <span class="text-muted ms-2 fw-normal" id="currentFilterLabel">All Assets</span>
                </h6>
            </div>
            
            <div class="card-body p-0">
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mb-0">Loading portfolio data...</p>
                </div>

                <!-- Holdings Container -->
                <div id="holdingsContainer" style="display: none;">
                    <!-- Mobile Card Layout -->
                    <div class="d-md-none p-3" id="mobileHoldings"></div>

                    <!-- Desktop Table Layout -->
                    <div class="d-none d-md-block" id="desktopHoldings">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="holdingsTable">
                                <thead class="table-light" id="tableHeader"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" style="display: none;">
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-chart-pie fa-3x text-muted"></i>
                        </div>
                        <h5 class="text-muted mb-2">No Portfolio Data</h5>
                        <p class="text-muted mb-4">Start building your portfolio by connecting broker accounts or uploading holdings.</p>
                        <div class="d-flex justify-content-center gap-2">
                            {% if has_broker_access %}
                            <a href="{{ url_for('dashboard_broker_accounts') }}" class="btn btn-primary">
                                <i class="fas fa-link me-2"></i>Connect Broker
                            </a>
                            {% endif %}
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-upload me-2"></i>Upload Holdings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Analysis Tabs -->
<div class="row" id="portfolioAnalysis" style="display: none;">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <ul class="nav nav-tabs card-header-tabs" id="analysisTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#assetAllocation" type="button">
                            <i class="fas fa-chart-pie me-1"></i>Asset Allocation
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sectorAllocation" type="button">
                            <i class="fas fa-chart-donut me-1"></i>Sector Allocation
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#aiRecommendations" type="button">
                            <i class="fas fa-lightbulb me-1"></i>AI Recommendations
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Asset Allocation Tab -->
                    <div class="tab-pane fade show active" id="assetAllocation">
                        <div id="assetAllocationChart"></div>
                    </div>
                    
                    <!-- Sector Allocation Tab -->
                    <div class="tab-pane fade" id="sectorAllocation">
                        <div id="sectorAllocationChart"></div>
                    </div>
                    
                    <!-- AI Recommendations Tab -->
                    <div class="tab-pane fade" id="aiRecommendations">
                        <div id="aiRecommendationsContent">
                            <div class="text-center py-4">
                                <i class="fas fa-robot fa-2x text-muted mb-3"></i>
                                <p class="text-muted">Complete your risk profile to get personalized AI recommendations</p>
                                <a href="{{ url_for('portfolio_risk_profile') }}" class="btn btn-outline-primary btn-sm">
                                    Complete Assessment
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Holdings Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Holdings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('portfolio_upload_holdings') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="holdings_file" class="form-label">Select CSV or Excel file</label>
                        <input type="file" class="form-control" id="holdings_file" name="holdings_file" accept=".csv,.xlsx,.xls" required>
                        <div class="form-text">
                            File should contain: symbol, company_name, quantity, purchase_price, purchase_date, sector, asset_type
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Formats:</strong> CSV, Excel (.xlsx, .xls)<br>
                            <strong>Assets:</strong> Stocks, MF, ETF, Bonds, Gold, Crypto, ESOP, Real Estate
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.cursor-pointer {
    cursor: pointer;
}
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}
.bg-gradient-danger {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
}
.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}
.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
}
</style>

<script>
// Portfolio Management JavaScript
let portfolioData = null;
let currentFilter = 'all';

// Asset type configuration
const assetTypeConfig = {
    'equities': {
        name: 'Stocks',
        icon: 'fas fa-chart-line',
        color: 'success',
        columns: ['Asset Details', 'Quantity', 'Avg Price', 'Current Price', 'Investment', 'Current Value', 'P&L', 'Actions']
    },
    'mutual_funds': {
        name: 'Mutual Funds',
        icon: 'fas fa-coins',
        color: 'info',
        columns: ['Fund Details', 'Units', 'NAV', 'Current NAV', 'Investment', 'Current Value', 'P&L', 'Actions']
    },
    'etf': {
        name: 'ETFs',
        icon: 'fas fa-exchange-alt',
        color: 'warning',
        columns: ['ETF Details', 'Units', 'Avg Price', 'Current Price', 'Investment', 'Current Value', 'P&L', 'Actions']
    },
    'futures_options': {
        name: 'F&O',
        icon: 'fas fa-hourglass-half',
        color: 'danger',
        columns: ['Contract Details', 'Lot Size', 'Strike', 'Expiry', 'Premium', 'Value', 'P&L', 'Actions']
    },
    'fixed_income': {
        name: 'Bonds',
        icon: 'fas fa-university',
        color: 'secondary',
        columns: ['Bond Details', 'Face Value', 'Rate', 'Maturity', 'Investment', 'Value', 'Interest', 'Actions']
    },
    'gold': {
        name: 'Gold',
        icon: 'fas fa-gem',
        color: 'dark',
        columns: ['Gold Details', 'Weight (g)', 'Purity', 'Purchase Price', 'Investment', 'Value', 'P&L', 'Actions']
    },
    'real_estate': {
        name: 'Real Estate',
        icon: 'fas fa-home',
        color: 'primary',
        columns: ['Property', 'Area', 'Type', 'Location', 'Investment', 'Value', 'P&L', 'Actions']
    },
    'nps': {
        name: 'NPS',
        icon: 'fas fa-umbrella',
        color: 'info',
        columns: ['NPS Details', 'Units', 'Tier', 'Fund Manager', 'Investment', 'Value', 'P&L', 'Actions']
    },
    'crypto': {
        name: 'Crypto',
        icon: 'fab fa-bitcoin',
        color: 'warning',
        columns: ['Crypto', 'Quantity', 'Avg Price', 'Current Price', 'Investment', 'Value', 'P&L', 'Actions']
    }
};

// Load portfolio data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPortfolioData();
});

function loadPortfolioData() {
    fetch('/api/portfolio')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                portfolioData = data.data;
                displayPortfolioData();
                updateFilterCount();
            } else {
                showEmptyState();
            }
        })
        .catch(error => {
            console.error('Error loading portfolio:', error);
            showEmptyState();
        });
}

function displayPortfolioData() {
    const loadingState = document.getElementById('loadingState');
    const holdingsContainer = document.getElementById('holdingsContainer');
    const emptyState = document.getElementById('emptyState');
    const portfolioAnalysis = document.getElementById('portfolioAnalysis');

    loadingState.style.display = 'none';
    
    if (!portfolioData || portfolioData.length === 0) {
        emptyState.style.display = 'block';
        holdingsContainer.style.display = 'none';
        portfolioAnalysis.style.display = 'none';
        return;
    }

    emptyState.style.display = 'none';
    holdingsContainer.style.display = 'block';
    portfolioAnalysis.style.display = 'block';

    filterByAssetType(currentFilter);
}

function filterByAssetType(assetType) {
    currentFilter = assetType;
    
    const filteredData = assetType === 'all' 
        ? portfolioData 
        : portfolioData.filter(item => item.asset_type === assetType);
    
    // Update filter label
    const config = assetTypeConfig[assetType];
    const filterLabel = assetType === 'all' ? 'All Assets' : config.name;
    document.getElementById('currentFilterLabel').textContent = filterLabel;
    document.getElementById('filterCount').textContent = `${filteredData.length} holding${filteredData.length !== 1 ? 's' : ''}`;
    
    // Render table
    renderHoldingsTable(filteredData, assetType);
}

function renderHoldingsTable(data, assetType) {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    // Get columns for asset type
    const config = assetType === 'all' ? assetTypeConfig['equities'] : assetTypeConfig[assetType];
    const columns = config.columns;
    
    // Build table header
    tableHeader.innerHTML = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
    
    // Build table body
    tableBody.innerHTML = data.map(holding => {
        const pnl = holding.current_value - holding.investment_value;
        const pnlPercentage = ((pnl / holding.investment_value) * 100).toFixed(2);
        const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
        
        return `
            <tr>
                <td>
                    <strong>${holding.symbol || holding.company_name}</strong><br>
                    <small class="text-muted">${holding.company_name || ''}</small>
                </td>
                <td>${holding.quantity || holding.units || '-'}</td>
                <td>₹${(holding.average_price || 0).toFixed(2)}</td>
                <td>₹${(holding.current_price || 0).toFixed(2)}</td>
                <td>₹${holding.investment_value.toLocaleString()}</td>
                <td>₹${holding.current_value.toLocaleString()}</td>
                <td class="${pnlClass}">
                    ${pnl >= 0 ? '+' : ''}₹${pnl.toLocaleString()}<br>
                    <small>(${pnlPercentage}%)</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetails(${holding.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Mobile view
    const mobileHoldings = document.getElementById('mobileHoldings');
    mobileHoldings.innerHTML = data.map(holding => {
        const pnl = holding.current_value - holding.investment_value;
        const pnlPercentage = ((pnl / holding.investment_value) * 100).toFixed(2);
        const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
        
        return `
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">${holding.symbol || holding.company_name}</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Value:</small><br>
                            <strong>₹${holding.current_value.toLocaleString()}</strong>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted">P&L:</small><br>
                            <strong class="${pnlClass}">${pnl >= 0 ? '+' : ''}₹${pnl.toLocaleString()}</strong>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function updateFilterCount() {
    // Update counts would go here
}

function showEmptyState() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('holdingsContainer').style.display = 'none';
}

function syncBrokerData() {
    // Sync broker data implementation
    alert('Syncing broker data...');
}

function viewDetails(holdingId) {
    // View holding details
    alert('View details for holding: ' + holdingId);
}
</script>

{% endblock %}
