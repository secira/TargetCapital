{% extends "dashboard/dashboard_base.html" %}

{% block title %}My Portfolio - tCapital{% endblock %}

{% block dashboard_title %}Unified Portfolio Analyzer{% endblock %}
{% block dashboard_subtitle %}
    {% if has_broker_access %}
        AI-powered comprehensive portfolio analysis with multi-broker integration
    {% else %}
        Advanced portfolio insights with AI-driven recommendations
    {% endif %}
{% endblock %}

{% block dashboard_content %}

<!-- AI Portfolio Health Score -->
<div class="grid-responsive mb-4">
    <div class="grid-item full-width">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <div class="position-relative d-inline-block">
                            <svg width="120" height="120" class="rotating-circle">
                                <circle cx="60" cy="60" r="45" stroke="#e9ecef" stroke-width="8" fill="none"/>
                                <circle cx="60" cy="60" r="45" stroke="#28a745" stroke-width="8" fill="none" 
                                        stroke-dasharray="283" stroke-dashoffset="{{ 283 - (283 * ((portfolio_analysis.ai_assessment.health_score or 75) | int) / 100) }}"
                                        transform="rotate(-90 60 60)"/>
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle text-center">
                                <h3 class="fw-bold mb-0">{{ portfolio_analysis.ai_assessment.health_score or 75 }}</h3>
                                <small class="text-muted">Health Score</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="fw-bold mb-2">Portfolio Health Assessment</h5>
                        <p class="text-muted mb-3">
                            Risk Level: <span class="badge bg-{{ 'success' if portfolio_analysis.ai_assessment.risk_level == 'Low' else 'warning' if portfolio_analysis.ai_assessment.risk_level == 'Medium' else 'danger' }}">
                                {{ portfolio_analysis.ai_assessment.risk_level or 'Medium' }}
                            </span>
                        </p>
                        <div class="ai-suggestions">
                            {% for suggestion in portfolio_analysis.ai_assessment.suggestions[:2] %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <small>{{ suggestion }}</small>
                            </div>
                            {% else %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-info-circle text-info me-2"></i>
                                <small>Connect broker accounts or upload holdings to get AI insights</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid gap-2">
                            {% if has_broker_access %}
                            <button class="btn btn-primary" onclick="syncBrokerData()">
                                <i class="fas fa-sync me-2"></i>Sync Brokers
                            </button>
                            {% endif %}
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-upload me-2"></i>Upload Holdings
                            </button>
                            <a href="{{ url_for('portfolio_risk_profile') }}" class="btn btn-outline-success">
                                <i class="fas fa-user-check me-2"></i>Risk Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient-primary text-white border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Total Value</h6>
                        <h4 class="mb-0">₹{{ "{:,.0f}".format(portfolio_analysis.portfolio_summary.total_value or 0) }}</h4>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient-{{ 'success' if (portfolio_analysis.portfolio_summary.total_pnl or 0) >= 0 else 'danger' }} text-white border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Total P&L</h6>
                        <h4 class="mb-0">
                            {{ '+' if (portfolio_analysis.portfolio_summary.total_pnl or 0) >= 0 else '' }}₹{{ "{:,.0f}".format(portfolio_analysis.portfolio_summary.total_pnl or 0) }}
                        </h4>
                        <small class="opacity-75">
                            {{ '+' if (portfolio_analysis.portfolio_summary.total_pnl_percentage or 0) >= 0 else '' }}{{ "%.2f"|format(portfolio_analysis.portfolio_summary.total_pnl_percentage or 0) }}%
                        </small>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient-info text-white border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Holdings</h6>
                        <h4 class="mb-0">{{ portfolio_analysis.portfolio_summary.holdings_count or 0 }}</h4>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-gradient-warning text-white border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 opacity-75">Brokers</h6>
                        <h4 class="mb-0">{{ portfolio_analysis.portfolio_summary.brokers_count or 0 }}</h4>
                    </div>
                    <div class="opacity-75">
                        <i class="fas fa-link fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Holdings Table -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h6 class="fw-bold mb-0"><i class="fas fa-list me-2"></i>Portfolio Holdings</h6>
            </div>
            
            <div class="card-body p-0">
                {% if portfolio_data %}
                <!-- Mobile Card Layout -->
                <div class="d-md-none p-3">
                    {% for holding in portfolio_data %}
                    <div class="card mb-2 border-start border-3 {{ 'border-success' if holding.pnl_amount >= 0 else 'border-danger' }}">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-6">
                                    <div class="fw-bold">{{ holding.ticker_symbol }}</div>
                                    <small class="text-muted">{{ holding.quantity }} × ₹{{ "%.0f"|format(holding.current_price or holding.purchase_price) }}</small>
                                </div>
                                <div class="col-3 text-end">
                                    <div class="fw-bold">₹{{ "%.0f"|format(holding.current_value or holding.purchased_value) }}</div>
                                    <small class="text-muted">Value</small>
                                </div>
                                <div class="col-3 text-end">
                                    <div class="{{ 'text-success' if holding.pnl_amount >= 0 else 'text-danger' }} fw-bold">
                                        {{ '+' if holding.pnl_amount >= 0 else '' }}₹{{ "%.0f"|format(holding.pnl_amount) }}
                                    </div>
                                    <small class="badge {{ 'bg-success' if holding.pnl_percentage >= 0 else 'bg-danger' }}">
                                        {{ '+' if holding.pnl_percentage >= 0 else '' }}{{ "%.1f"|format(holding.pnl_percentage) }}%
                                    </small>
                                </div>
                            </div>
                            <div class="row mt-1">
                                <div class="col-12">
                                    <div class="btn-group btn-group-sm w-100">
                                        <button class="btn btn-outline-success" onclick="tradeHolding('{{ holding.ticker_symbol }}', 'BUY', {{ holding.current_price or holding.purchase_price }}, '{{ holding.stock_name }}')">
                                            <i class="fas fa-plus me-1"></i>Buy
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="tradeHolding('{{ holding.ticker_symbol }}', 'SELL', {{ holding.current_price or holding.purchase_price }}, '{{ holding.stock_name }}')">
                                            <i class="fas fa-minus me-1"></i>Sell
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Desktop Table Layout -->
                <div class="d-none d-md-block">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%;">Stock Details</th>
                                <th style="width: 10%;" class="text-center">Quantity</th>
                                <th style="width: 12%;" class="text-end d-none d-lg-table-cell">Avg Price</th>
                                <th style="width: 12%;" class="text-end">Current Price</th>
                                <th style="width: 12%;" class="text-end d-none d-lg-table-cell">Investment</th>
                                <th style="width: 12%;" class="text-end">Current Value</th>
                                <th style="width: 12%;" class="text-end">P&L Amount</th>
                                <th style="width: 10%;" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for holding in portfolio_data %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <div class="fw-bold fs-6">{{ holding.ticker_symbol }}</div>
                                            <div class="text-muted small">{{ holding.stock_name[:25] }}{{ '...' if holding.stock_name|length > 25 else '' }}</div>
                                            <div class="text-muted small">{{ holding.sector or 'N/A' }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="fw-semibold">{{ holding.quantity }}</span>
                                </td>
                                <td class="text-end d-none d-lg-table-cell">
                                    <span class="text-muted">₹{{ "{:,.0f}".format(holding.purchase_price) }}</span>
                                </td>
                                <td class="text-end">
                                    <span class="fw-semibold">₹{{ "{:,.0f}".format(holding.current_price or holding.purchase_price) }}</span>
                                </td>
                                <td class="text-end d-none d-lg-table-cell">
                                    <span class="text-muted">₹{{ "{:,.0f}".format(holding.purchased_value) }}</span>
                                </td>
                                <td class="text-end">
                                    <span class="fw-semibold">₹{{ "{:,.0f}".format(holding.current_value or holding.purchased_value) }}</span>
                                </td>
                                <td class="text-end">
                                    <div class="{{ holding.get_pnl_class() }} fw-bold">
                                        {{ '+' if holding.pnl_amount >= 0 else '' }}₹{{ "{:,.0f}".format(holding.pnl_amount) }}
                                    </div>
                                    <span class="badge {{ 'bg-success' if holding.pnl_percentage >= 0 else 'bg-danger' }}">
                                        {{ '+' if holding.pnl_percentage >= 0 else '' }}{{ "%.1f"|format(holding.pnl_percentage) }}%
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-success btn-sm" onclick="tradeHolding('{{ holding.ticker_symbol }}', 'BUY', {{ holding.current_price or holding.purchase_price }}, '{{ holding.stock_name }}')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="tradeHolding('{{ holding.ticker_symbol }}', 'SELL', {{ holding.current_price or holding.purchase_price }}, '{{ holding.stock_name }}')">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <!-- Empty State -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-chart-pie fa-4x text-muted"></i>
                    </div>
                    <h5 class="text-muted mb-3">No Portfolio Data</h5>
                    <p class="text-muted mb-4">Start building your portfolio by connecting broker accounts or uploading holdings manually.</p>
                    <div class="d-flex justify-content-center gap-2">
                        {% if has_broker_access %}
                        <a href="{{ url_for('dashboard_broker_accounts') }}" class="btn btn-primary">
                            <i class="fas fa-link me-2"></i>Connect Broker
                        </a>
                        {% endif %}
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-2"></i>Upload Holdings
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Analysis Sections -->
{% if portfolio_data %}
<div class="row mt-4">
    <!-- Sector Allocation -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h6 class="fw-bold mb-0"><i class="fas fa-chart-pie me-2"></i>Sector Allocation</h6>
            </div>
            <div class="card-body">
                {% for sector, percentage in portfolio_analysis.sector_allocation.items() %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div><strong>{{ sector }}</strong></div>
                    <div><span class="badge bg-primary">{{ "%.1f"|format(percentage) }}%</span></div>
                </div>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar" style="width: {{ percentage }}%"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- AI Recommendations -->
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h6 class="fw-bold mb-0"><i class="fas fa-lightbulb me-2"></i>AI Recommendations</h6>
            </div>
            <div class="card-body">
                {% for suggestion in portfolio_analysis.ai_assessment.suggestions %}
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="fas fa-lightbulb me-2"></i>
                    <small>{{ suggestion }}</small>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-robot fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Complete your risk profile to get personalized recommendations</p>
                    <a href="{{ url_for('portfolio_risk_profile') }}" class="btn btn-outline-primary btn-sm">
                        Complete Assessment
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Upload Holdings Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Holdings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('portfolio_upload_holdings') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="holdings_file" class="form-label">Select CSV or Excel file</label>
                        <input type="file" class="form-control" id="holdings_file" name="holdings_file" accept=".csv,.xlsx,.xls" required>
                        <div class="form-text">
                            File should contain columns: symbol, company_name, quantity, purchase_price, purchase_date, sector, asset_type
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Supported formats:</strong> CSV, Excel (.xlsx, .xls)<br>
                        <strong>Data types:</strong> Stocks, MF, ETF, Bonds, Gold, Crypto, ESOP, Private Equity
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function syncBrokerData() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Syncing...';
    
    fetch('{{ url_for("portfolio_sync_brokers") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Sync failed: ' + (data.error || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-sync me-2"></i>Sync Brokers';
        }
    })
    .catch(error => {
        alert('Sync failed: ' + error);
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-sync me-2"></i>Sync Brokers';
    });
}

function tradeHolding(symbol, action, currentPrice, companyName) {
    // Navigate to Trade Now page with holding parameters
    const params = new URLSearchParams({
        symbol: symbol,
        action: action,
        price: currentPrice,
        quantity: action === 'SELL' ? 0 : 10, // 0 for sell (user will specify), 10 default for buy
        type: 'stock',
        company_name: companyName,
        source: 'my_portfolio'
    });
    
    window.location.href = `/dashboard/trade-now?${params.toString()}`;
}
</script>

<style>
.rotating-circle {
    transform: rotate(-90deg);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.bg-gradient-danger {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    color: #333 !important;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
}
</style>

{% endblock %}