{% extends "dashboard/dashboard_base.html" %}

{% block title %}Broker Trading - tCapital{% endblock %}

{% block dashboard_title %}Live Trading Interface{% endblock %}
{% block dashboard_subtitle %}Place orders directly through your connected broker accounts{% endblock %}

{% block dashboard_content %}

<!-- Broker Selection and Status -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Connected Brokers</h6>
            </div>
            <div class="card-body">
                {% if broker_accounts %}
                <div class="row">
                    {% for account in broker_accounts %}
                    <div class="col-md-6 mb-3">
                        <div class="broker-card p-3 border rounded {{ 'border-success' if account.is_primary else 'border-secondary' }}" 
                             onclick="selectBroker({{ account.id }})">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">{{ account.broker_name }}</div>
                                    <small class="text-muted">{{ account.get_credentials()['client_id'][:8] }}...</small>
                                    {% if account.is_primary %}
                                        <span class="badge bg-primary ms-2">Primary</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">Balance: ₹{{ "{:,.0f}".format(account.account_balance) if account.account_balance else 'N/A' }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-unlink fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-2">No brokers connected</p>
                    <a href="{{ url_for('dashboard_broker_accounts') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Connect Broker
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Quick Market Data</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-2">
                        <div class="fw-bold text-success">NIFTY 50</div>
                        <div class="text-muted">25,041.10</div>
                        <small class="text-success">+0.8%</small>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="fw-bold text-danger">SENSEX</div>
                        <div class="text-muted">81,741.34</div>
                        <small class="text-danger">-0.2%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Placement Form -->
{% if broker_accounts %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Place Order</h6>
            </div>
            <div class="card-body">
                <form id="orderForm">
                    <div class="mb-3">
                        <label for="orderSymbol" class="form-label">Symbol</label>
                        <input type="text" class="form-control" id="orderSymbol" placeholder="e.g., RELIANCE, INFY" required>
                        <div class="form-text">Enter NSE stock symbol</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="transactionType" class="form-label">Type</label>
                            <select class="form-control" id="transactionType" required>
                                <option value="buy">BUY</option>
                                <option value="sell">SELL</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" min="1" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="orderType" class="form-label">Order Type</label>
                            <select class="form-control" id="orderType" required>
                                <option value="market">MARKET</option>
                                <option value="limit">LIMIT</option>
                                <option value="sl">STOP LOSS</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="productType" class="form-label">Product</label>
                            <select class="form-control" id="productType" required>
                                <option value="intraday">INTRADAY</option>
                                <option value="delivery">DELIVERY</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="priceField" style="display: none;">
                        <label for="price" class="form-label">Price</label>
                        <input type="number" class="form-control" id="price" step="0.01">
                    </div>
                    
                    <div class="mb-3">
                        <label for="brokerAccount" class="form-label">Broker Account</label>
                        <select class="form-control" id="brokerAccount">
                            {% for account in broker_accounts %}
                            <option value="{{ account.id }}" {{ 'selected' if account.is_primary else '' }}>
                                {{ account.broker_name }} ({{ account.get_credentials()['client_id'][:8] }}...)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-bolt me-2"></i>Place Order
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Order Preview</h6>
            </div>
            <div class="card-body">
                <div id="orderPreview">
                    <div class="text-muted text-center py-4">
                        Fill in order details to see preview
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Orders -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Recent Orders</h6>
        <button class="btn btn-outline-primary btn-sm" onclick="refreshOrders()">
            <i class="fas fa-sync me-2"></i>Refresh
        </button>
    </div>
    <div class="card-body">
        {% if recent_orders %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Broker</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr>
                        <td>{{ order.order_time.strftime('%H:%M') }}</td>
                        <td>
                            <div class="fw-bold">{{ order.symbol }}</div>
                        </td>
                        <td>
                            <span class="badge {{ 'bg-success' if order.transaction_type.value == 'buy' else 'bg-danger' }}">
                                {{ order.transaction_type.value.upper() }}
                            </span>
                        </td>
                        <td>{{ order.quantity }}</td>
                        <td>
                            {% if order.order_type.value == 'market' %}
                                Market
                            {% else %}
                                ₹{{ "{:,.2f}".format(order.price) }}
                            {% endif %}
                        </td>
                        <td>
                            {% set status_class = {
                                'complete': 'bg-success',
                                'open': 'bg-primary',
                                'cancelled': 'bg-warning',
                                'rejected': 'bg-danger',
                                'pending': 'bg-info'
                            } %}
                            <span class="badge {{ status_class.get(order.order_status.value, 'bg-secondary') }}">
                                {{ order.order_status.value.upper() }}
                            </span>
                        </td>
                        <td>{{ order.broker_account.broker_name }}</td>
                        <td>
                            {% if order.order_status.value in ['open', 'pending'] %}
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder('{{ order.broker_order_id }}')">
                                    Cancel
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-receipt fa-2x text-muted mb-2"></i>
            <p class="text-muted">No recent orders</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
let selectedBrokerId = {{ broker_accounts[0].id if broker_accounts else 'null' }};

// Broker selection
function selectBroker(brokerId) {
    selectedBrokerId = brokerId;
    document.getElementById('brokerAccount').value = brokerId;
    
    // Update visual selection
    document.querySelectorAll('.broker-card').forEach(card => {
        card.classList.remove('border-primary');
        card.classList.add('border-secondary');
    });
    event.target.closest('.broker-card').classList.remove('border-secondary');
    event.target.closest('.broker-card').classList.add('border-primary');
}

// Order type change handler
document.getElementById('orderType').addEventListener('change', function() {
    const priceField = document.getElementById('priceField');
    if (this.value === 'limit' || this.value === 'sl') {
        priceField.style.display = 'block';
        document.getElementById('price').required = true;
    } else {
        priceField.style.display = 'none';
        document.getElementById('price').required = false;
    }
    updateOrderPreview();
});

// Update order preview
function updateOrderPreview() {
    const symbol = document.getElementById('orderSymbol').value;
    const type = document.getElementById('transactionType').value;
    const qty = document.getElementById('quantity').value;
    const orderType = document.getElementById('orderType').value;
    const productType = document.getElementById('productType').value;
    const price = document.getElementById('price').value;
    
    if (!symbol || !qty) {
        document.getElementById('orderPreview').innerHTML = 
            '<div class="text-muted text-center py-4">Fill in order details to see preview</div>';
        return;
    }
    
    const previewHtml = `
        <div class="border rounded p-3">
            <h6 class="fw-bold text-${type === 'buy' ? 'success' : 'danger'}">${type.toUpperCase()} ${symbol}</h6>
            <div class="row">
                <div class="col-6">
                    <small class="text-muted">Quantity:</small>
                    <div class="fw-bold">${qty}</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Type:</small>
                    <div class="fw-bold">${orderType.toUpperCase()}</div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-6">
                    <small class="text-muted">Product:</small>
                    <div class="fw-bold">${productType.toUpperCase()}</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Price:</small>
                    <div class="fw-bold">${orderType === 'market' ? 'Market' : '₹' + (price || '0.00')}</div>
                </div>
            </div>
            ${orderType !== 'market' && price ? 
                `<div class="mt-2 text-muted">
                    <small>Estimated Value: ₹${(parseFloat(price) * parseInt(qty)).toLocaleString()}</small>
                </div>` : ''
            }
        </div>
    `;
    
    document.getElementById('orderPreview').innerHTML = previewHtml;
}

// Add event listeners for form inputs
['orderSymbol', 'transactionType', 'quantity', 'orderType', 'productType', 'price'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateOrderPreview);
    document.getElementById(id).addEventListener('change', updateOrderPreview);
});

// Form submission
document.getElementById('orderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const orderData = {
        symbol: document.getElementById('orderSymbol').value.toUpperCase(),
        trading_symbol: document.getElementById('orderSymbol').value.toUpperCase() + '-EQ',
        transaction_type: document.getElementById('transactionType').value,
        quantity: parseInt(document.getElementById('quantity').value),
        order_type: document.getElementById('orderType').value,
        product_type: document.getElementById('productType').value,
        price: parseFloat(document.getElementById('price').value) || 0,
        broker_account_id: parseInt(document.getElementById('brokerAccount').value)
    };
    
    // Validate required fields
    if (!orderData.symbol || !orderData.quantity) {
        alert('Please fill in all required fields');
        return;
    }
    
    if ((orderData.order_type === 'limit' || orderData.order_type === 'sl') && !orderData.price) {
        alert('Price is required for limit and stop loss orders');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('#orderForm button[type="submit"]');
    const originalHtml = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Placing Order...';
    
    // Place order
    fetch('/api/broker/place-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Order placed successfully! Order ID: ' + data.broker_order_id);
            document.getElementById('orderForm').reset();
            updateOrderPreview();
            refreshOrders();
        } else {
            alert('Order failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Order placement failed. Please try again.');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHtml;
    });
});

// Refresh orders
function refreshOrders() {
    location.reload();
}

// Cancel order
function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) return;
    
    fetch(`/api/broker/cancel-order/${orderId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Order cancelled successfully');
            refreshOrders();
        } else {
            alert('Failed to cancel order: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to cancel order. Please try again.');
    });
}
</script>

<style>
.broker-card {
    cursor: pointer;
    transition: all 0.2s;
}

.broker-card:hover {
    background-color: #f8f9fa;
}

.table th {
    font-weight: 600;
    background-color: #f8f9fa;
    border-top: none;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}
</style>

{% endblock %}