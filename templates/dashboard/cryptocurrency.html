{% extends "dashboard/dashboard_base.html" %}

{% block title %}Cryptocurrency - Target Capital{% endblock %}
{% block dashboard_title %}Cryptocurrency Portfolio{% endblock %}
{% block dashboard_subtitle %}Manage your crypto holdings across exchanges and wallets{% endblock %}

{% block dashboard_toolbar %}
<div class="header-actions">
    <button type="button" class="btn btn-sm btn-primary" onclick="toggleAddCryptoForm()">
        <i class="fas fa-plus me-1"></i>Add Cryptocurrency
    </button>
    <a href="{{ url_for('import_holdings', asset_class='cryptocurrency') }}" class="btn btn-sm btn-success">
        <i class="fas fa-file-import me-1"></i>Import
    </a>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
        <i class="fas fa-sync me-1"></i>Refresh
    </button>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Add Cryptocurrency Form (Initially Hidden) -->
<div class="card mb-4" id="addCryptoFormCard" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Add Cryptocurrency Holding</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAddCryptoForm()">
            <i class="fas fa-times"></i> Cancel
        </button>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('dashboard_cryptocurrency') }}">
            <div class="row">
                <!-- Cryptocurrency Details -->
                <div class="col-md-6 mb-3">
                    <label for="crypto_symbol" class="form-label">Cryptocurrency <span class="text-danger">*</span></label>
                    <select class="form-select" id="crypto_symbol" name="crypto_symbol" required onchange="updateCryptoName()">
                        <option value="">Select Cryptocurrency</option>
                        <option value="BTC" data-name="Bitcoin">Bitcoin (BTC)</option>
                        <option value="ETH" data-name="Ethereum">Ethereum (ETH)</option>
                        <option value="BNB" data-name="Binance Coin">Binance Coin (BNB)</option>
                        <option value="XRP" data-name="Ripple">Ripple (XRP)</option>
                        <option value="ADA" data-name="Cardano">Cardano (ADA)</option>
                        <option value="SOL" data-name="Solana">Solana (SOL)</option>
                        <option value="DOGE" data-name="Dogecoin">Dogecoin (DOGE)</option>
                        <option value="DOT" data-name="Polkadot">Polkadot (DOT)</option>
                        <option value="MATIC" data-name="Polygon">Polygon (MATIC)</option>
                        <option value="SHIB" data-name="Shiba Inu">Shiba Inu (SHIB)</option>
                        <option value="LTC" data-name="Litecoin">Litecoin (LTC)</option>
                        <option value="UNI" data-name="Uniswap">Uniswap (UNI)</option>
                        <option value="AVAX" data-name="Avalanche">Avalanche (AVAX)</option>
                        <option value="LINK" data-name="Chainlink">Chainlink (LINK)</option>
                        <option value="TRX" data-name="TRON">TRON (TRX)</option>
                        <option value="ATOM" data-name="Cosmos">Cosmos (ATOM)</option>
                        <option value="XLM" data-name="Stellar">Stellar (XLM)</option>
                        <option value="USDT" data-name="Tether">Tether (USDT)</option>
                        <option value="USDC" data-name="USD Coin">USD Coin (USDC)</option>
                    </select>
                    <input type="hidden" id="crypto_name" name="crypto_name">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="platform" class="form-label">Platform/Exchange</label>
                    <select class="form-select" id="platform" name="platform">
                        <option value="">Select Platform</option>
                        <option value="WazirX">WazirX</option>
                        <option value="CoinDCX">CoinDCX</option>
                        <option value="CoinSwitch Kuber">CoinSwitch Kuber</option>
                        <option value="Binance">Binance</option>
                        <option value="ZebPay">ZebPay</option>
                        <option value="Coinbase">Coinbase</option>
                        <option value="Kraken">Kraken</option>
                        <option value="Unocoin">Unocoin</option>
                        <option value="Hardware Wallet">Hardware Wallet</option>
                        <option value="MetaMask">MetaMask</option>
                        <option value="Trust Wallet">Trust Wallet</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <!-- Wallet Details -->
                <div class="col-md-6 mb-3">
                    <label for="wallet_type" class="form-label">Wallet Type</label>
                    <select class="form-select" id="wallet_type" name="wallet_type">
                        <option value="">Select Wallet Type</option>
                        <option value="Exchange Wallet">Exchange Wallet</option>
                        <option value="Hardware Wallet">Hardware Wallet (Ledger/Trezor)</option>
                        <option value="Software Wallet">Software Wallet</option>
                        <option value="Mobile Wallet">Mobile Wallet</option>
                        <option value="Cold Storage">Cold Storage</option>
                        <option value="Hot Wallet">Hot Wallet</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="wallet_address" class="form-label">Wallet Address (Optional)</label>
                    <input type="text" class="form-control" id="wallet_address" name="wallet_address" placeholder="Wallet address">
                    <small class="text-muted">For tracking purposes only</small>
                </div>
                
                <!-- Purchase Details -->
                <div class="col-12 mb-2">
                    <h6 class="text-muted">Purchase Details</h6>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="purchase_date" class="form-label">Purchase Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="purchase_date" name="purchase_date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="quantity" class="form-label">Quantity/Units <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="quantity" name="quantity" step="0.00000001" required placeholder="0.5">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="purchase_rate_inr" class="form-label">Purchase Rate (₹/coin) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="purchase_rate_inr" name="purchase_rate_inr" step="0.01" required placeholder="3500000.00">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="purchase_amount" class="form-label">Purchase Amount (₹) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="purchase_amount" name="purchase_amount" step="0.01" required placeholder="1750000.00">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="transaction_fee" class="form-label">Transaction Fee (₹)</label>
                    <input type="number" class="form-control" id="transaction_fee" name="transaction_fee" step="0.01" placeholder="0.00">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="gas_fee" class="form-label">Gas Fee (₹)</label>
                    <input type="number" class="form-control" id="gas_fee" name="gas_fee" step="0.01" placeholder="0.00">
                    <small class="text-muted">For ETH transfers</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="other_charges" class="form-label">Other Charges (₹)</label>
                    <input type="number" class="form-control" id="other_charges" name="other_charges" step="0.01" placeholder="0.00">
                </div>
                
                <!-- Transaction Details -->
                <div class="col-md-6 mb-3">
                    <label for="transaction_id" class="form-label">Transaction ID</label>
                    <input type="text" class="form-control" id="transaction_id" name="transaction_id" placeholder="Transaction ID">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="transaction_hash" class="form-label">Transaction Hash</label>
                    <input type="text" class="form-control" id="transaction_hash" name="transaction_hash" placeholder="0x...">
                </div>
                
                <!-- Current Valuation -->
                <div class="col-12 mb-2">
                    <h6 class="text-muted">Current Valuation (Optional)</h6>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="current_rate_inr" class="form-label">Current Rate (₹/coin)</label>
                    <input type="number" class="form-control" id="current_rate_inr" name="current_rate_inr" step="0.01" placeholder="4200000.00">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="current_market_value" class="form-label">Current Value (₹)</label>
                    <input type="number" class="form-control" id="current_market_value" name="current_market_value" step="0.01" placeholder="2100000.00">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="valuation_date" class="form-label">Valuation Date</label>
                    <input type="date" class="form-control" id="valuation_date" name="valuation_date">
                </div>
                
                <!-- Staking Details -->
                <div class="col-12 mb-2">
                    <h6 class="text-muted">Staking Details (If Applicable)</h6>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_staked" name="is_staked">
                        <label class="form-check-label" for="is_staked">
                            Currently Staked
                        </label>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="staking_platform" class="form-label">Staking Platform</label>
                    <input type="text" class="form-control" id="staking_platform" name="staking_platform" placeholder="e.g., Binance Earn">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="staking_apy" class="form-label">Staking APY (%)</label>
                    <input type="number" class="form-control" id="staking_apy" name="staking_apy" step="0.01" placeholder="5.00">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="staking_rewards_earned" class="form-label">Rewards Earned (₹)</label>
                    <input type="number" class="form-control" id="staking_rewards_earned" name="staking_rewards_earned" step="0.01" placeholder="0.00">
                </div>
                
                <!-- Additional Info -->
                <div class="col-md-6 mb-3">
                    <label for="portfolio_name" class="form-label">Portfolio Name</label>
                    <input type="text" class="form-control" id="portfolio_name" name="portfolio_name" value="Default" placeholder="Default">
                </div>
                <div class="col-12 mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Any additional notes..."></textarea>
                </div>
            </div>
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-secondary" onclick="toggleAddCryptoForm()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Save Cryptocurrency
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <!-- Holdings Summary -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Total Investment</h6>
                <h3 class="mb-0">₹{{ "{:,.0f}".format(total_investment) if total_investment else '0' }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Current Value</h6>
                <h3 class="mb-0">₹{{ "{:,.0f}".format(current_value) if current_value else '0' }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Unrealized Gain</h6>
                <h3 class="mb-0 {% if total_gain >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ₹{{ "{:,.0f}".format(total_gain) if total_gain else '0' }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Holdings</h6>
                <h3 class="mb-0">{{ holdings_count }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Holdings Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Cryptocurrency Holdings</h5>
        <div class="btn-group btn-group-sm" role="group">
            <input type="radio" class="btn-check" name="filterType" id="allFilter" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="allFilter" onclick="filterHoldings('all')">All</label>
            
            <input type="radio" class="btn-check" name="filterType" id="btcFilter" autocomplete="off">
            <label class="btn btn-outline-primary" for="btcFilter" onclick="filterHoldings('BTC')">Bitcoin</label>
            
            <input type="radio" class="btn-check" name="filterType" id="ethFilter" autocomplete="off">
            <label class="btn btn-outline-primary" for="ethFilter" onclick="filterHoldings('ETH')">Ethereum</label>
        </div>
    </div>
    <div class="card-body">
        {% if holdings %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Cryptocurrency</th>
                        <th>Platform</th>
                        <th>Quantity</th>
                        <th>Avg. Buy Price</th>
                        <th>Investment</th>
                        <th>Current Value</th>
                        <th>Gain/Loss</th>
                        <th>Gain %</th>
                        <th>Staking</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="holdingsTable">
                    {% for holding in holdings %}
                    <tr class="holding-row" data-symbol="{{ holding.crypto_symbol }}">
                        <td>
                            <strong>{{ holding.crypto_name }}</strong><br>
                            <span class="badge bg-primary">{{ holding.crypto_symbol }}</span>
                        </td>
                        <td>{{ holding.platform or '-' }}</td>
                        <td>{{ "{:.8f}".format(holding.quantity) }}</td>
                        <td>₹{{ "{:,.2f}".format(holding.purchase_rate_inr) }}</td>
                        <td>₹{{ "{:,.0f}".format(holding.total_investment) }}</td>
                        <td>₹{{ "{:,.0f}".format(holding.current_market_value) if holding.current_market_value else '-' }}</td>
                        <td class="{% if holding.unrealized_gain and holding.unrealized_gain >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if holding.unrealized_gain %}
                            ₹{{ "{:,.0f}".format(holding.unrealized_gain) }}
                            {% else %}-{% endif %}
                        </td>
                        <td class="{% if holding.unrealized_gain_percentage and holding.unrealized_gain_percentage >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if holding.unrealized_gain_percentage %}
                            {{ "{:,.1f}".format(holding.unrealized_gain_percentage) }}%
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if holding.is_staked %}
                            <span class="badge bg-success">Staked</span><br>
                            <small class="text-muted">{{ "{:.2f}".format(holding.staking_apy) if holding.staking_apy else '0' }}% APY</small>
                            {% else %}
                            <span class="badge bg-secondary">Not Staked</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editHolding({{ holding.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteHolding({{ holding.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fab fa-bitcoin fa-3x text-muted mb-3"></i>
            <p class="text-muted">No cryptocurrency holdings found. Add your first crypto!</p>
            <button class="btn btn-primary" onclick="toggleAddCryptoForm()">
                <i class="fas fa-plus me-2"></i>Add Cryptocurrency
            </button>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const purchaseDateInput = document.getElementById('purchase_date');
    if (purchaseDateInput) {
        purchaseDateInput.max = new Date().toISOString().split('T')[0];
    }
    
    // Auto-calculate purchase amount based on quantity and rate
    const quantityInput = document.getElementById('quantity');
    const rateInput = document.getElementById('purchase_rate_inr');
    const amountInput = document.getElementById('purchase_amount');
    
    function calculateAmount() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        if (quantity > 0 && rate > 0) {
            amountInput.value = (quantity * rate).toFixed(2);
        }
    }
    
    if (quantityInput && rateInput && amountInput) {
        quantityInput.addEventListener('input', calculateAmount);
        rateInput.addEventListener('input', calculateAmount);
    }
    
    // Auto-calculate current value
    const currentRateInput = document.getElementById('current_rate_inr');
    const currentValueInput = document.getElementById('current_market_value');
    
    function calculateCurrentValue() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const currentRate = parseFloat(currentRateInput.value) || 0;
        if (quantity > 0 && currentRate > 0) {
            currentValueInput.value = (quantity * currentRate).toFixed(2);
        }
    }
    
    if (currentRateInput && currentValueInput && quantityInput) {
        currentRateInput.addEventListener('input', calculateCurrentValue);
    }
});

function updateCryptoName() {
    const select = document.getElementById('crypto_symbol');
    const hiddenInput = document.getElementById('crypto_name');
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption) {
        hiddenInput.value = selectedOption.getAttribute('data-name') || '';
    }
}

function toggleAddCryptoForm() {
    const formCard = document.getElementById('addCryptoFormCard');
    if (formCard) {
        if (formCard.style.display === 'none') {
            formCard.style.display = 'block';
            formCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => {
                const firstSelect = formCard.querySelector('select');
                if (firstSelect) {
                    firstSelect.focus();
                }
            }, 300);
        } else {
            formCard.style.display = 'none';
        }
    }
}

function filterHoldings(symbol) {
    const rows = document.querySelectorAll('.holding-row');
    rows.forEach(row => {
        if (symbol === 'all') {
            row.style.display = '';
        } else {
            row.style.display = row.dataset.symbol === symbol ? '' : 'none';
        }
    });
}

function editHolding(id) {
    alert('Edit functionality coming soon!');
}

function deleteHolding(id) {
    if (confirm('Are you sure you want to delete this cryptocurrency holding?')) {
        fetch(`/api/cryptocurrency/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting holding: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}
