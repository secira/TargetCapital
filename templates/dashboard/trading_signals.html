{% extends "dashboard/dashboard_base.html" %}

{% block title %}Smart Signals - tCapital Dashboard{% endblock %}

{% block extra_css %}
<style>
/* Slicker, Lighter Font Styling */
.card-body, 
.table, 
.trading-signals-table,
.alert,
.btn,
h5, h6 {
    font-weight: 300 !important; /* Light weight */
    letter-spacing: 0.3px;
}

.trading-signals-table th {
    font-weight: 400 !important; /* Regular weight for headers */
}

.trading-signals-table td {
    font-weight: 300 !important; /* Light weight for content */
}

/* Keep badges and buttons slightly bolder for emphasis */
.badge, .btn-success, .btn-primary {
    font-weight: 500 !important;
}

/* Trading Signals Table Improvements - Fixed Layout */
.trading-signals-table {
    table-layout: fixed !important;
    width: 100% !important;
    min-width: 1900px !important;
}

.trading-signals-table th,
.trading-signals-table td {
    padding: 12px 8px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    vertical-align: middle !important;
}

/* Enhanced Table Container */
.table-responsive-enhanced {
    overflow-x: auto;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Improved Mobile Responsive Behavior */
@media (max-width: 768px) {
    .trading-signals-table {
        min-width: 1600px !important;
    }
    
    .trading-signals-table th,
    .trading-signals-table td {
        padding: 8px 4px !important;
        font-size: 12px;
    }
}

/* Remove any potential conflicting styles */
.trading-signals-table th,
.trading-signals-table td {
    border: none !important;
}

/* AI Research Score Circle */
.score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(#10b981 0%, #e5e7eb 0%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.score-circle::before {
    content: '';
    position: absolute;
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: white;
}

.score-value {
    position: relative;
    z-index: 1;
    font-size: 28px;
    font-weight: 700;
    color: #1a1a1a;
}

.score-circle.strong-buy { background: conic-gradient(#10b981 var(--score-pct), #e5e7eb 0%); }
.score-circle.buy { background: conic-gradient(#3b82f6 var(--score-pct), #e5e7eb 0%); }
.score-circle.hold { background: conic-gradient(#6b7280 var(--score-pct), #e5e7eb 0%); }
.score-circle.sell { background: conic-gradient(#f59e0b var(--score-pct), #e5e7eb 0%); }
.score-circle.strong-sell { background: conic-gradient(#ef4444 var(--score-pct), #e5e7eb 0%); }

/* AI Research Panel Toggle Animation */
#aiResearchPanel.collapsing {
    transition: height 0.3s ease;
}

#aiResearchToggleIcon {
    transition: transform 0.3s ease;
}

#aiResearchPanel.show + #aiResearchToggleIcon,
[aria-expanded="true"] #aiResearchToggleIcon {
    transform: rotate(180deg);
}
</style>
{% endblock %}

{% block dashboard_title %}Smart Signals{% endblock %}
{% block dashboard_subtitle %}Daily recommendations from our expert analysts{% endblock %}

{% block dashboard_toolbar %}
<div class="d-flex justify-content-end align-items-center mb-3">
    <div id="live-indicator" class="badge bg-success">
        <i class="fas fa-circle me-1"></i>Live
    </div>
</div>
{% endblock %}

{% block dashboard_content %}

    <!-- AI Research & Analysis Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #00091a 0%, #1a365d 100%); border-radius: 12px 12px 0 0;">
                    <div>
                        <h5 class="mb-0"><i class="fas fa-brain me-2"></i>AI Research Engine</h5>
                        <small class="opacity-75">Multi-component sentiment analysis powered by LangGraph</small>
                    </div>
                    <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#aiResearchPanel" aria-expanded="false">
                        <i class="fas fa-chevron-down" id="aiResearchToggleIcon"></i>
                    </button>
                </div>
                <div class="collapse show" id="aiResearchPanel">
                    <div class="card-body p-4">
                        <form id="aiResearchForm">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2">
                                    <label class="form-label small text-muted mb-1">Asset Type</label>
                                    <select class="form-select" id="assetType" name="asset_type">
                                        <option value="stocks" selected>Stocks (Equity)</option>
                                        <option value="futures">Index Futures</option>
                                        <option value="options">Stock Options</option>
                                        <option value="commodities">Commodities</option>
                                        <option value="crypto">Cryptocurrency</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted mb-1">Symbol / Asset Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                        <input type="text" class="form-control border-start-0" id="symbolSearch" name="symbol" placeholder="e.g., RELIANCE, TATAMOTORS" autocomplete="off" list="symbolSuggestions">
                                        <datalist id="symbolSuggestions">
                                            <option value="RELIANCE">Reliance Industries</option>
                                            <option value="TCS">Tata Consultancy Services</option>
                                            <option value="INFY">Infosys</option>
                                            <option value="HDFC">HDFC Bank</option>
                                            <option value="ICICIBANK">ICICI Bank</option>
                                            <option value="TATAMOTORS">Tata Motors</option>
                                            <option value="SBIN">State Bank of India</option>
                                            <option value="HDFCBANK">HDFC Bank</option>
                                            <option value="BAJFINANCE">Bajaj Finance</option>
                                            <option value="WIPRO">Wipro</option>
                                        </datalist>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small text-muted mb-1">From Date</label>
                                    <input type="date" class="form-control" id="analysisFromDate" name="date_from" value="{{ (today - timedelta(days=30)).strftime('%Y-%m-%d') if today else '' }}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small text-muted mb-1">To Date</label>
                                    <input type="date" class="form-control" id="analysisToDate" name="date_to" value="{{ today.strftime('%Y-%m-%d') if today else '' }}">
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary w-100" id="analyseBtn" style="background: #00091a; border-color: #00091a;">
                                        <i class="fas fa-robot me-2"></i>Generate AI Signals
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                        <span class="text-muted small">Components:</span>
                                        <span class="badge bg-info text-white"><i class="fas fa-newspaper me-1"></i>Qualitative 15%</span>
                                        <span class="badge bg-primary"><i class="fas fa-chart-bar me-1"></i>Quantitative 50%</span>
                                        <span class="badge bg-warning text-dark"><i class="fas fa-search me-1"></i>Search 10%</span>
                                        <span class="badge bg-success"><i class="fas fa-chart-line me-1"></i>Trend 25%</span>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Analysis Results Panel (Hidden initially) -->
                        <div id="analysisResultsPanel" class="mt-4" style="display: none;">
                            <hr>
                            <div class="row g-3">
                                <!-- Overall Score Card -->
                                <div class="col-md-4">
                                    <div class="card h-100 border-0 bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted mb-3">Overall Score</h6>
                                            <div class="position-relative d-inline-block">
                                                <div class="score-circle" id="overallScoreCircle">
                                                    <span class="score-value" id="overallScoreValue">--</span>
                                                </div>
                                            </div>
                                            <div id="recommendationBadge" class="mt-3">
                                                <span class="badge bg-secondary fs-6">Analysing...</span>
                                            </div>
                                            <p class="text-muted small mt-2 mb-0" id="confidenceText">Confidence: --</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Component Scores -->
                                <div class="col-md-8">
                                    <div class="card h-100 border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="text-muted mb-3">Component Analysis</h6>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="small"><i class="fas fa-newspaper text-info me-1"></i>Qualitative (15%)</span>
                                                    <span class="small fw-bold" id="qualScore">--/100</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-info" id="qualProgress" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="small"><i class="fas fa-chart-bar text-primary me-1"></i>Quantitative (50%)</span>
                                                    <span class="small fw-bold" id="quantScore">--/100</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-primary" id="quantProgress" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="small"><i class="fas fa-search text-warning me-1"></i>Search Sentiment (10%)</span>
                                                    <span class="small fw-bold" id="searchScore">--/100</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-warning" id="searchProgress" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-0">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="small"><i class="fas fa-chart-line text-success me-1"></i>Trend Analysis (25%)</span>
                                                    <span class="small fw-bold" id="trendScore">--/100</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-success" id="trendProgress" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recommendation Summary -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-light border mb-0" id="recommendationSummary">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                        <span id="summaryText">Analysis summary will appear here...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Component Analysis (Expandable) -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="accordion" id="detailedAnalysisAccordion">
                                        <!-- Qualitative Analysis Details -->
                                        <div class="accordion-item border-0 mb-2">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#qualitativeDetails">
                                                    <i class="fas fa-newspaper text-info me-2"></i>
                                                    <strong>Qualitative Analysis Details</strong>
                                                    <span class="badge bg-info ms-auto me-2" id="qualSignalBadge">--</span>
                                                </button>
                                            </h2>
                                            <div id="qualitativeDetails" class="accordion-collapse collapse" data-bs-parent="#detailedAnalysisAccordion">
                                                <div class="accordion-body bg-white">
                                                    <div id="qualitativeContent">
                                                        <p class="text-muted">Loading qualitative analysis...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Quantitative Analysis Details -->
                                        <div class="accordion-item border-0 mb-2">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#quantitativeDetails">
                                                    <i class="fas fa-chart-bar text-primary me-2"></i>
                                                    <strong>Quantitative Analysis Details</strong>
                                                    <span class="badge bg-primary ms-auto me-2" id="quantSignalBadge">--</span>
                                                </button>
                                            </h2>
                                            <div id="quantitativeDetails" class="accordion-collapse collapse" data-bs-parent="#detailedAnalysisAccordion">
                                                <div class="accordion-body bg-white">
                                                    <div id="quantitativeContent">
                                                        <p class="text-muted">Loading quantitative analysis...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Search Sentiment Details -->
                                        <div class="accordion-item border-0 mb-2">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#searchDetails">
                                                    <i class="fas fa-search text-warning me-2"></i>
                                                    <strong>Search Sentiment Details</strong>
                                                    <span class="badge bg-warning text-dark ms-auto me-2" id="searchSignalBadge">--</span>
                                                </button>
                                            </h2>
                                            <div id="searchDetails" class="accordion-collapse collapse" data-bs-parent="#detailedAnalysisAccordion">
                                                <div class="accordion-body bg-white">
                                                    <div id="searchContent">
                                                        <p class="text-muted">Loading search sentiment analysis...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Trend Analysis Details -->
                                        <div class="accordion-item border-0 mb-2">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#trendDetails">
                                                    <i class="fas fa-chart-line text-success me-2"></i>
                                                    <strong>Trend Analysis Details</strong>
                                                    <span class="badge bg-success ms-auto me-2" id="trendSignalBadge">--</span>
                                                </button>
                                            </h2>
                                            <div id="trendDetails" class="accordion-collapse collapse" data-bs-parent="#detailedAnalysisAccordion">
                                                <div class="accordion-body bg-white">
                                                    <div id="trendContent">
                                                        <p class="text-muted">Loading trend analysis...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="analysisLoading" class="mt-4 text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mb-0">Running AI analysis pipeline...</p>
                            <small class="text-muted" id="pipelineStage">Preparing context...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LangGraph Signal Pipeline Visualization (Admin Only) -->
    {% if current_user.is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>LangGraph Smart Signal Pipeline</h5>
                </div>
                <div class="card-body">
                    <div id="signalPipelineWorkflow"></div>
                    <div id="pipelineResults" class="mt-4" style="display: none;">
                        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-chart-line me-2"></i>Generated Signals</h6>
                        <div id="pipelineSignals"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Trading Signals Table -->
    <div class="card border-0 shadow-sm rounded-3" id="signals-container">
        <div class="card-body p-0">
            {% if signals %}
            <div class="table-responsive table-responsive-enhanced">
                <table class="table table-hover mb-0 trading-signals-table">
                    <colgroup>
                        <col style="width: 220px;">  <!-- Symbol -->
                        <col style="width: 90px;">   <!-- Type -->
                        <col style="width: 90px;">   <!-- Action -->
                        <col style="width: 140px;">  <!-- Current Price -->
                        <col style="width: 140px;">  <!-- Entry Price -->
                        <col style="width: 140px;">  <!-- Target -->
                        <col style="width: 140px;">  <!-- Stop Loss -->
                        <col style="width: 120px;">  <!-- Return -->
                        <col style="width: 90px;">   <!-- Qty -->
                        <col style="width: 140px;">  <!-- Risk -->
                        <col style="width: 120px;">  <!-- Time -->
                        <col style="width: 160px;">  <!-- Actions -->
                    </colgroup>
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th class="border-0 ps-3">Symbol</th>
                            <th class="border-0">Type</th>
                            <th class="border-0">Action</th>
                            <th class="border-0">Current Price <i class="fas fa-circle text-success" style="font-size: 6px;"></i></th>
                            <th class="border-0">Entry Price</th>
                            <th class="border-0">Target</th>
                            <th class="border-0">Stop Loss</th>
                            <th class="border-0">Return</th>
                            <th class="border-0">Qty</th>
                            <th class="border-0">Risk</th>
                            <th class="border-0">Time</th>
                            <th class="border-0 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for signal in signals %}
                        <tr class="signal-row" data-type="{{ signal.signal_type }}" data-signal-id="{{ signal.id }}">
                            <td class="ps-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        {% if signal.signal_type == 'stock' %}
                                            <i class="fas fa-chart-line text-primary"></i>
                                        {% elif signal.signal_type == 'option' %}
                                            <i class="fas fa-cog text-warning"></i>
                                        {% elif signal.signal_type == 'index_future' %}
                                            <i class="fas fa-chart-area text-info"></i>
                                        {% else %}
                                            <i class="fas fa-chess text-success"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ signal.symbol }}</div>
                                        {% if signal.company_name %}
                                        <small class="text-muted">{{ signal.company_name[:25] }}{% if signal.company_name|length > 25 %}...{% endif %}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary text-white small">
                                    {% if signal.signal_type == 'stock' %}
                                        Stock
                                    {% elif signal.signal_type == 'option' %}
                                        Option
                                    {% elif signal.signal_type == 'index_future' %}
                                        Future
                                    {% else %}
                                        Strategy
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if signal.action == 'BUY' else 'danger' if signal.action == 'SELL' else 'warning' }} fw-bold">
                                    {{ signal.action }}
                                </span>
                            </td>
                            <td class="fw-bold current-price" data-symbol="{{ signal.symbol }}">
                                <span class="text-muted">Loading...</span>
                            </td>
                            <td class="fw-bold">
                                {% if signal.entry_price %}
                                    ₹{{ "{:,.2f}".format(signal.entry_price) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-success fw-bold">
                                {% if signal.target_price %}
                                    ₹{{ "{:,.2f}".format(signal.target_price) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-danger fw-bold">
                                {% if signal.stop_loss %}
                                    ₹{{ "{:,.2f}".format(signal.stop_loss) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if signal.entry_price and signal.target_price %}
                                    <div class="fw-bold text-success">
                                        +{{ "{:.1f}".format(signal.potential_return) }}%
                                    </div>
                                    <small class="text-muted">Expected</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="fw-bold">
                                {{ signal.quantity or '-' }}
                            </td>
                            <td>
                                {% if signal.risk_level %}
                                <div class="d-flex align-items-center">
                                    {% if signal.risk_level == 'LOW' %}
                                        <span class="badge bg-success text-white small me-1">●</span>
                                        <span class="fw-bold text-success small">Low Risk</span>
                                    {% elif signal.risk_level == 'MEDIUM' %}
                                        <span class="badge bg-warning text-white small me-1">●</span>
                                        <span class="fw-bold text-warning small">Medium</span>
                                    {% else %}
                                        <span class="badge bg-danger text-white small me-1">●</span>
                                        <span class="fw-bold text-danger small">High Risk</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>
                                    <small class="text-muted">{{ signal.created_at.strftime('%I:%M %p') }}</small>
                                    <div>
                                        {% if signal.time_frame %}
                                        <span class="badge bg-light text-dark small">{{ signal.time_frame }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="btn-group">
                                    {% if current_user.pricing_plan in [PricingPlan.TARGET_PRO, PricingPlan.HNI] %}
                                    <button class="btn btn-success btn-sm" 
                                            onclick="tradeSignal('{{ signal.symbol }}', '{{ signal.action }}', {{ signal.entry_price }}, {{ signal.quantity or 100 }}, '{{ signal.signal_type }}', {{ signal.id }})"
                                            title="Execute Trade">
                                        <i class="fas fa-rocket"></i>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-secondary btn-sm" 
                                            onclick="showUpgradeToProAlert()"
                                            title="Upgrade to TARGET PRO to Trade">
                                        <i class="fas fa-lock"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="showSignalDetails({{ signal.id }})"
                                            title="View Details">
                                        <i class="fas fa-info"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Smart Signals Available</h4>
                <p class="text-muted">Our AI hasn't generated any signals yet. Check back later for new recommendations.</p>
                <button class="btn btn-primary" onclick="refreshSignals()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh Signals
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Signal Details Modal -->
    <div class="modal fade" id="signalDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Signal Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="signalDetailsContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="modalTradeButton">
                        <i class="fas fa-exchange-alt me-1"></i>Trade Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Information Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-gradient-primary text-white border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>How to Use Smart Signals
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <i class="fas fa-eye fa-2x text-primary mb-2"></i>
                                <h6>1. Review</h6>
                                <small class="text-muted">Analyze the signal details, entry price, and strategy</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <i class="fas fa-calculator fa-2x text-info mb-2"></i>
                                <h6>2. Calculate</h6>
                                <small class="text-muted">Determine position size based on your risk tolerance</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <i class="fas fa-play fa-2x text-success mb-2"></i>
                                <h6>3. Execute</h6>
                                <small class="text-muted">Place the trade with your connected broker</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-3">
                                <i class="fas fa-chart-bar fa-2x text-warning mb-2"></i>
                                <h6>4. Monitor</h6>
                                <small class="text-muted">Track performance and manage exits</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 mt-3">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>Risk Disclaimer:</strong> Smart Signals are for educational purposes. Past performance doesn't guarantee future results. Trade at your own risk and never invest more than you can afford to lose.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- AI Stock Picker Section - TEMPORARILY DISABLED FOR TESTING -->
<!-- Will be re-enabled after testing other features -->
<!--
<div class="mt-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center mb-4">
                <div class="flex-grow-1">
                    <h4 class="fw-bold mb-1">
                        <i class="fas fa-robot me-2 text-primary"></i>AI Generated Stock Picks
                    </h4>
                    <p class="text-muted mb-0">AI-powered stock recommendations and market research</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary btn-sm" onclick="generateAIRecommendations()">
                        <i class="fas fa-robot me-1"></i>Generate AI Picks
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12 text-center">
            <button type="button" class="btn btn-primary btn-lg" onclick="generatePerplexityPicks()">
                <i class="fas fa-magic me-2"></i>Generate New AI Picks
            </button>
        </div>
    </div>

    <div class="row mb-4" id="researchLoading" style="display: none;">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Researching...</span>
                    </div>
                    <h5 class="mt-3">AI is analyzing market data...</h5>
                    <p class="text-muted">Using advanced algorithms to identify the best investment opportunities</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="researchResults" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>AI Research Results</h5>
                    <span class="badge bg-success">Generated by Agentic AI</span>
                </div>
                <div class="card-body" id="researchResultsBody">
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                        <div>
                            <h5 class="mb-1"><i class="fas fa-star me-2 text-warning"></i>Today's Top AI Picks</h5>
                            <div class="d-flex flex-wrap gap-1 text-muted small">
                                <span><i class="fas fa-brain text-primary me-1"></i>Perplexity AI</span>
                                <span class="d-none d-sm-inline">•</span>
                                <span><i class="fas fa-chart-line text-success me-1"></i>NSE (5-min)</span>
                                <span class="d-none d-sm-inline">•</span>
                                <span class="d-none d-sm-inline"><i class="fas fa-clock text-warning me-1"></i>Real-time</span>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-1">
                            <input type="date" class="form-control form-control-sm" id="picksDate" value="{{ today.strftime('%Y-%m-%d') if today else '' }}" onchange="loadAIPicksForDate(this.value)" style="width: 140px; max-width: 140px;">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshStockPrices()" title="Refresh prices">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if ai_picks %}
                    <div class="d-none d-md-block">
                        <div style="width: 100%; overflow: hidden;">
                            <table class="table table-hover mb-0" style="width: 100%; table-layout: fixed; margin: 0;">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0" style="width: 22%; padding: 0.75rem 0.5rem;">Stock</th>
                                        <th class="border-0" style="width: 13%; padding: 0.75rem 0.25rem;">Price</th>
                                        <th class="border-0" style="width: 15%; padding: 0.75rem 0.25rem;">Target</th>
                                        <th class="border-0" style="width: 10%; padding: 0.75rem 0.25rem;">Rec.</th>
                                        <th class="border-0" style="width: 12%; padding: 0.75rem 0.25rem;">Conf.</th>
                                        <th class="border-0" style="width: 12%; padding: 0.75rem 0.25rem;">Sector</th>
                                        <th class="border-0" style="width: 16%; padding: 0.75rem 0.25rem;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pick in ai_picks %}
                                    <tr>
                                        <td class="border-0" style="padding: 0.75rem 0.5rem; overflow: hidden; text-overflow: ellipsis;">
                                            <div style="max-width: 100%; overflow: hidden;">
                                                <strong class="d-block" style="font-size: 0.9rem;">{{ pick.symbol }}</strong>
                                                <small class="text-muted" style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block;">{{ pick.company_name[:20] }}{% if pick.company_name|length > 20 %}...{% endif %}</small>
                                            </div>
                                        </td>
                                        <td class="border-0" style="padding: 0.75rem 0.25rem; font-size: 0.85rem;">
                                            <strong>₹{{ "%.0f"|format(pick.current_price) }}</strong>
                                        </td>
                                        <td class="border-0" style="padding: 0.75rem 0.25rem; font-size: 0.8rem;">
                                            {% if pick.target_price %}
                                            <div>
                                                <strong style="font-size: 0.8rem;">₹{{ "%.0f"|format(pick.target_price) }}</strong>
                                                {% set upside = ((pick.target_price - pick.current_price) / pick.current_price * 100) %}
                                                <small class="d-block {% if upside > 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 0.7rem;">
                                                    +{{ "%.0f"|format(upside) }}%
                                                </small>
                                            </div>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="border-0" style="padding: 0.75rem 0.25rem;">
                                            <span class="badge {% if pick.recommendation == 'BUY' %}bg-success{% elif pick.recommendation == 'SELL' %}bg-danger{% else %}bg-warning{% endif %}" style="font-size: 0.7rem; padding: 0.3rem 0.4rem;">
                                                {{ pick.recommendation }}
                                            </span>
                                        </td>
                                        <td class="border-0" style="padding: 0.75rem 0.25rem;">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <div class="progress" style="height: 6px; width: 30px; margin-right: 0.25rem;">
                                                    <div class="progress-bar {% if pick.confidence_score >= 80 %}bg-success{% elif pick.confidence_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         style="width: {{ pick.confidence_score }}%"></div>
                                                </div>
                                                <small style="font-size: 0.7rem;">{{ pick.confidence_score }}%</small>
                                            </div>
                                        </td>
                                        <td class="border-0" style="padding: 0.75rem 0.25rem;">
                                            <span class="badge bg-light text-dark" style="font-size: 0.65rem; padding: 0.25rem 0.4rem;">{{ pick.sector[:6] }}{% if pick.sector|length > 6 %}...{% endif %}</span>
                                        </td>
                                        <td class="border-0" style="padding: 0.75rem 0.25rem;">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-success" onclick="tradeStock('{{ pick.symbol }}', '{{ pick.recommendation }}', {{ pick.current_price }}, '{{ pick.company_name }}')" title="Trade" style="padding: 0.25rem 0.4rem;">
                                                    <i class="fas fa-exchange-alt" style="font-size: 0.75rem;"></i>
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="viewDetailedAnalysis('{{ pick.symbol }}')" title="Analyze" style="padding: 0.25rem 0.4rem;">
                                                    <i class="fas fa-chart-bar" style="font-size: 0.75rem;"></i>
                                                </button>
                                                <button class="btn btn-outline-info" onclick="addToWatchlist('{{ pick.symbol }}')" title="Watch" style="padding: 0.25rem 0.4rem;">
                                                    <i class="fas fa-star" style="font-size: 0.75rem;"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="d-md-none">
                        {% for pick in ai_picks %}
                        <div class="card border-0 border-bottom rounded-0">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <h6 class="mb-0 fw-bold">{{ pick.symbol }}</h6>
                                                <small class="text-muted">{{ pick.company_name }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <div class="mb-1">
                                            <strong class="fs-5">₹{{ "%.2f"|format(pick.current_price) }}</strong>
                                            {% if pick.target_price %}
                                            {% set upside = ((pick.target_price - pick.current_price) / pick.current_price * 100) %}
                                            <small class="d-block {% if upside > 0 %}text-success{% else %}text-danger{% endif %}">
                                                Target: ₹{{ "%.2f"|format(pick.target_price) }} ({{ "%.1f"|format(upside) }}%)
                                            </small>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex justify-content-end gap-1">
                                            <span class="badge {% if pick.recommendation == 'BUY' %}bg-success{% elif pick.recommendation == 'SELL' %}bg-danger{% else %}bg-warning{% endif %}">
                                                {{ pick.recommendation }}
                                            </span>
                                            <span class="badge bg-light text-dark">{{ pick.confidence_score }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-chart-line fa-3x text-primary opacity-50"></i>
                        </div>
                        <h5 class="text-muted mb-3">No AI picks available for {{ today.strftime('%B %d, %Y') if today else 'today' }}</h5>
                        <p class="text-muted mb-4">Generate fresh AI-powered stock recommendations based on current market conditions.</p>
                        <button type="button" class="btn btn-primary" onclick="generatePerplexityPicks()">
                            <i class="fas fa-magic me-2"></i>Generate AI Picks Now
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
-->

<!-- Trade Support Pipeline Modal -->
<div class="modal fade" id="tradeExecutionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-rocket me-2"></i>Trade Support Pipeline
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Signal Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-info-circle me-3 fa-2x"></i>
                            <div>
                                <h6 class="mb-1" id="tradeExecutionSignal">Loading...</h6>
                                <small id="tradeExecutionDetails">Validating trade parameters through 6-stage pipeline...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6-Stage Visual Workflow -->
                <div id="tradeExecutionWorkflow"></div>

                <!-- Validation Errors (if any) -->
                <div id="tradeExecutionErrors" class="mt-4" style="display: none;">
                    <div class="alert alert-danger">
                        <h6 class="alert-heading mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>Validation Failed
                        </h6>
                        <div id="tradeExecutionErrorList"></div>
                    </div>
                </div>

                <!-- Execution Plan (on success) -->
                <div id="tradeExecutionPlan" class="mt-4" style="display: none;">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Execution Plan Ready</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr>
                                            <th width="40%">Symbol:</th>
                                            <td id="planSymbol" class="fw-bold">-</td>
                                        </tr>
                                        <tr>
                                            <th>Action:</th>
                                            <td id="planAction" class="fw-bold">-</td>
                                        </tr>
                                        <tr>
                                            <th>Quantity:</th>
                                            <td id="planQuantity" class="fw-bold">-</td>
                                        </tr>
                                        <tr>
                                            <th>Entry Price:</th>
                                            <td id="planEntry" class="fw-bold">-</td>
                                        </tr>
                                        <tr>
                                            <th>Broker:</th>
                                            <td id="planBroker" class="fw-bold">-</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr>
                                            <th width="40%">Target:</th>
                                            <td id="planTarget" class="fw-bold text-success">-</td>
                                        </tr>
                                        <tr>
                                            <th>Stop Loss:</th>
                                            <td id="planStopLoss" class="fw-bold text-danger">-</td>
                                        </tr>
                                        <tr>
                                            <th>Order Value:</th>
                                            <td id="planOrderValue" class="fw-bold">-</td>
                                        </tr>
                                        <tr>
                                            <th>Risk Amount:</th>
                                            <td id="planRiskAmount" class="fw-bold text-danger">-</td>
                                        </tr>
                                        <tr>
                                            <th>Risk:Reward:</th>
                                            <td id="planRiskReward" class="fw-bold text-success">-</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-success" id="confirmTradeBtn" style="display: none;" onclick="confirmTrade()">
                    <i class="fas fa-check me-2"></i>Confirm & Execute Trade
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables for signal management
let isLiveMode = true;
let autoRefreshInterval;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    startLiveUpdates();
    updateLiveIndicator();
    loadCurrentPrices(); // Load real-time prices on page load
    
    // Pre-load LangGraph visual script for trade execution
    const script = document.createElement('script');
    script.src = '/static/js/langgraph-visual.js';
    script.onload = function() {
        console.log('✅ LangGraph visual script loaded');
    };
    script.onerror = function() {
        console.error('❌ Failed to load LangGraph visual script');
    };
    document.head.appendChild(script);
});

async function loadCurrentPrices() {
    try {
        const response = await fetch('/api/trading-signals');
        const data = await response.json();
        
        if (data.success && data.signals) {
            data.signals.forEach(signal => {
                const priceCell = document.querySelector(`.current-price[data-symbol="${signal.symbol}"]`);
                if (priceCell && signal.current_price) {
                    // Calculate price change color
                    let priceClass = 'text-primary';
                    let changeIcon = '';
                    if (signal.price_change_percent) {
                        if (signal.price_change_percent > 0) {
                            priceClass = 'text-success';
                            changeIcon = '<i class="fas fa-arrow-up ms-1"></i>';
                        } else if (signal.price_change_percent < 0) {
                            priceClass = 'text-danger';
                            changeIcon = '<i class="fas fa-arrow-down ms-1"></i>';
                        }
                    }
                    
                    priceCell.innerHTML = `
                        <span class="${priceClass}">₹${signal.current_price.toFixed(2)}</span>
                        ${changeIcon}
                        ${signal.price_change_percent ? '<br><small class="' + priceClass + '">' + (signal.price_change_percent > 0 ? '+' : '') + signal.price_change_percent.toFixed(2) + '%</small>' : ''}
                    `;
                } else if (priceCell) {
                    priceCell.innerHTML = '<span class="text-muted">-</span>';
                }
            });
        }
    } catch (error) {
        console.error('Error loading current prices:', error);
    }
}

function refreshSignals() {
    const liveBtn = document.querySelector('button[onclick="refreshSignals()"]');
    const originalText = liveBtn.innerHTML;
    liveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    
    // Load current prices via AJAX instead of full page reload
    loadCurrentPrices().then(() => {
        liveBtn.innerHTML = originalText;
    }).catch(() => {
        location.reload(); // Fallback to full reload on error
    });
}

// Initialize LangGraph Signal Pipeline
let signalPipeline;
document.addEventListener('DOMContentLoaded', function() {
    // Load the LangGraph visual script
    const script = document.createElement('script');
    script.src = '/static/js/langgraph-visual.js';
    script.onload = function() {
        if (document.getElementById('signalPipelineWorkflow')) {
            signalPipeline = new SignalPipelineWorkflow('signalPipelineWorkflow');
            window.signalWorkflow = signalPipeline; // Make available globally for click handlers
        }
    };
    document.head.appendChild(script);
});

async function generateLangGraphSignals() {
    const generateBtn = document.getElementById('generateBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running Signal Pipeline...';
    
    // Reset pipeline
    if (signalPipeline) {
        signalPipeline.reset();
    }
    
    try {
        // Start visual pipeline animation
        const pipelinePromise = signalPipeline ? signalPipeline.runPipeline() : Promise.resolve();
        
        // Call LangGraph API
        const response = await fetch('/api/signals/generate-langgraph', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                market: 'NSE',
                signal_count: 5
            })
        });
        
        const result = await response.json();
        
        // Wait for pipeline animation to complete
        await pipelinePromise;
        
        if (result.success) {
            // Update pipeline metrics
            if (signalPipeline && result.pipeline_metadata) {
                signalPipeline.updateMetrics({
                    scanned: result.pipeline_metadata.total_scanned || 0,
                    generated: result.pipeline_metadata.generated || 0,
                    validated: result.pipeline_metadata.validated || 0,
                    ready: result.pipeline_metadata.execution_ready || 0
                });
            }
            
            // Show results
            if (result.signals && result.signals.length > 0) {
                document.getElementById('pipelineResults').style.display = 'block';
                document.getElementById('pipelineSignals').innerHTML = formatSignals(result.signals);
                document.getElementById('pipelineResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            alert('✅ LangGraph AI successfully generated ' + (result.signals_count || result.signals.length) + ' new trading signals!');
            
            // Reload after a delay to show new signals in table
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('❌ Error: ' + (result.error || 'Failed to generate signals'));
        }
    } catch (error) {
        console.error('Error generating signals:', error);
        alert('❌ Error generating signals: ' + error.message);
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalText;
    }
}

function formatSignals(signals) {
    if (!signals || signals.length === 0) {
        return '<p class="text-muted">No signals generated</p>';
    }
    
    return `
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Action</th>
                        <th>Entry</th>
                        <th>Target</th>
                        <th>Stop Loss</th>
                        <th>R:R</th>
                    </tr>
                </thead>
                <tbody>
                    ${signals.map(s => `
                        <tr>
                            <td><strong>${s.symbol || s.Symbol || 'N/A'}</strong></td>
                            <td><span class="badge ${s.action === 'BUY' ? 'bg-success' : 'bg-danger'}">${s.action || s.Action || 'N/A'}</span></td>
                            <td>₹${s.entry_price || s['Entry Price'] || 0}</td>
                            <td>₹${s.target_price || s['Target Price'] || 0}</td>
                            <td>₹${s.stop_loss || s['Stop Loss'] || 0}</td>
                            <td>${s.risk_reward_ratio || s['Risk/Reward Ratio'] || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function filterSignals(type) {
    const signalRows = document.querySelectorAll('.signal-row');
    const filterButtons = document.querySelectorAll('[onclick^="filterSignals"]');
    
    // Update button states
    filterButtons.forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    event.target.classList.remove('btn-outline-primary');
    event.target.classList.add('btn-primary');
    
    // Filter rows
    signalRows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function showUpgradeAlert() {
    alert('targetcapital.ai says: Upgrade to view Smart Signals. FREE users have access to Research Assistant only.');
    window.location.href = '/pricing';
}

function showUpgradeToProAlert() {
    alert('targetcapital.ai says: Upgrade to TARGET PRO (₹2,499) or HNI (₹4,999) to execute trades with your primary broker. TARGET PLUS users can view signals but cannot trade.');
    window.location.href = '/pricing';
}

// Global variables for trade execution
let tradeExecutionWorkflow;
let currentExecutionPlan = null;

async function tradeSignal(symbol, action, entryPrice, quantity, signalType, signalId = null) {
    // Check subscription access - only TARGET_PRO and HNI can trade
    {% if current_user.pricing_plan not in [PricingPlan.TARGET_PRO, PricingPlan.HNI] %}
        showUpgradeToProAlert();
        return;
    {% endif %}
    
    // Initialize workflow if not already done
    if (!tradeExecutionWorkflow) {
        await loadTradeExecutionWorkflow();
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('tradeExecutionModal'));
    modal.show();
    
    // Update signal details in modal
    document.getElementById('tradeExecutionSignal').textContent = `${symbol} - ${action} @ ₹${entryPrice}`;
    document.getElementById('tradeExecutionDetails').textContent = 'Validating trade through 6-stage pipeline...';
    
    // Reset modal states
    document.getElementById('tradeExecutionErrors').style.display = 'none';
    document.getElementById('tradeExecutionPlan').style.display = 'none';
    document.getElementById('confirmTradeBtn').style.display = 'none';
    
    // Reset workflow visual
    tradeExecutionWorkflow.reset();
    
    // Get signal data (either from table or from button click)
    const signalRow = document.querySelector(`[data-signal-id="${signalId}"]`);
    let targetPrice = 0;
    let stopLoss = 0;
    
    if (signalRow) {
        // Extract from table
        const targetCell = signalRow.querySelector('td:nth-child(6)');
        const stopCell = signalRow.querySelector('td:nth-child(7)');
        targetPrice = targetCell ? parseFloat(targetCell.textContent.replace('₹', '').replace(',', '')) : 0;
        stopLoss = stopCell ? parseFloat(stopCell.textContent.replace('₹', '').replace(',', '')) : 0;
    }
    
    // Prepare validation request
    const validationData = {
        symbol: symbol,
        action: action,
        entry_price: parseFloat(entryPrice),
        target_price: targetPrice,
        stop_loss: stopLoss,
        quantity: parseInt(quantity) || 100,
        timeframe: signalType === 'stock' ? 'Swing' : 'Intraday'
    };
    
    if (signalId) {
        validationData.signal_id = signalId;
    }
    
    try {
        // Call validation API
        const response = await fetch('/api/trade/validate-execution', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(validationData)
        });
        
        const result = await response.json();
        
        // Update visual workflow with stage statuses
        if (result.stage_status) {
            tradeExecutionWorkflow.runPipeline(result.stage_status);
        }
        
        // Show results
        if (result.success && result.execution_plan) {
            // All stages passed - show execution plan
            currentExecutionPlan = result.execution_plan;
            displayExecutionPlan(result.execution_plan);
            document.getElementById('confirmTradeBtn').style.display = 'block';
            document.getElementById('tradeExecutionDetails').textContent = '✓ All validations passed! Review and confirm trade.';
        } else {
            // Validation failed - show errors
            displayValidationErrors(result.validation_errors || ['Unknown error occurred']);
            document.getElementById('tradeExecutionDetails').textContent = '✗ Validation failed. Please review errors below.';
        }
        
    } catch (error) {
        console.error('Trade validation error:', error);
        displayValidationErrors([`System error: ${error.message}`]);
        document.getElementById('tradeExecutionDetails').textContent = '✗ System error occurred.';
    }
}

function displayExecutionPlan(plan) {
    // Populate execution plan details
    document.getElementById('planSymbol').textContent = plan.symbol || '-';
    document.getElementById('planAction').textContent = plan.action || '-';
    document.getElementById('planAction').className = 'fw-bold badge bg-' + (plan.action === 'BUY' ? 'success' : 'danger');
    document.getElementById('planQuantity').textContent = plan.quantity || '-';
    document.getElementById('planEntry').textContent = plan.entry_price ? `₹${plan.entry_price.toFixed(2)}` : '-';
    document.getElementById('planTarget').textContent = plan.target ? `₹${plan.target.toFixed(2)}` : '-';
    document.getElementById('planStopLoss').textContent = plan.stop_loss ? `₹${plan.stop_loss.toFixed(2)}` : '-';
    document.getElementById('planBroker').textContent = plan.broker_name || '-';
    document.getElementById('planOrderValue').textContent = plan.order_value ? `₹${plan.order_value.toFixed(2)}` : '-';
    document.getElementById('planRiskAmount').textContent = plan.risk_amount ? `₹${plan.risk_amount.toFixed(2)}` : '-';
    document.getElementById('planRiskReward').textContent = plan.risk_reward_ratio ? `1:${plan.risk_reward_ratio.toFixed(2)}` : '-';
    
    // Show plan card
    document.getElementById('tradeExecutionPlan').style.display = 'block';
}

function displayValidationErrors(errors) {
    const errorList = document.getElementById('tradeExecutionErrorList');
    errorList.innerHTML = errors.map(err => `
        <div class="mb-2">
            <i class="fas fa-times-circle me-2"></i>${err}
        </div>
    `).join('');
    
    document.getElementById('tradeExecutionErrors').style.display = 'block';
}

async function confirmTrade() {
    if (!currentExecutionPlan) {
        alert('No execution plan available');
        return;
    }
    
    const confirmBtn = document.getElementById('confirmTradeBtn');
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Executing...';
    confirmBtn.disabled = true;
    
    try {
        const response = await fetch('/api/trade/execute-confirmed', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                execution_plan: currentExecutionPlan
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Success - close modal and show success message
            bootstrap.Modal.getInstance(document.getElementById('tradeExecutionModal')).hide();
            
            // Show success notification
            const successAlert = `
                <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999;" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Order Placed Successfully!</strong> Order ID: ${result.order_id}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', successAlert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert-success');
                if (alert) alert.remove();
            }, 5000);
            
            // Refresh signals table
            refreshSignals();
        } else {
            throw new Error(result.error || 'Trade execution failed');
        }
        
    } catch (error) {
        console.error('Trade execution error:', error);
        alert(`Trade execution failed: ${error.message}`);
        
        confirmBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm & Execute Trade';
        confirmBtn.disabled = false;
    }
}

async function loadTradeExecutionWorkflow() {
    // Wait for script to be loaded if not already
    let attempts = 0;
    while (!window.TradeExecutionWorkflow && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (!window.TradeExecutionWorkflow) {
        console.error('❌ TradeExecutionWorkflow class not found');
        throw new Error('Failed to load trade execution workflow');
    }
    
    // Initialize workflow
    console.log('✅ Initializing TradeExecutionWorkflow');
    tradeExecutionWorkflow = new window.TradeExecutionWorkflow('tradeExecutionWorkflow');
    console.log('✅ TradeExecutionWorkflow initialized:', tradeExecutionWorkflow);
}

function showSignalDetails(signalId) {
    // Mock signal details - replace with actual AJAX call
    const signalData = {
        symbol: 'RELIANCE',
        action: 'BUY',
        entryPrice: 2840.50,
        targetPrice: 3100.00,
        stopLoss: 2750.00,
        notes: 'Strong breakout above resistance level with high volume. RSI showing bullish momentum.',
        strategy: 'Momentum Breakout',
        timeFrame: 'SWING'
    };
    
    const modalContent = document.getElementById('signalDetailsContent');
    modalContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Signal Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Symbol:</strong></td><td>${signalData.symbol}</td></tr>
                    <tr><td><strong>Action:</strong></td><td><span class="badge bg-success">${signalData.action}</span></td></tr>
                    <tr><td><strong>Entry Price:</strong></td><td>₹${signalData.entryPrice}</td></tr>
                    <tr><td><strong>Target Price:</strong></td><td class="text-success">₹${signalData.targetPrice}</td></tr>
                    <tr><td><strong>Stop Loss:</strong></td><td class="text-danger">₹${signalData.stopLoss}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Strategy Details</h6>
                <p><strong>Strategy:</strong> ${signalData.strategy}</p>
                <p><strong>Time Frame:</strong> ${signalData.timeFrame}</p>
                <p><strong>Analysis:</strong></p>
                <p class="small">${signalData.notes}</p>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('signalDetailsModal'));
    modal.show();
}

function loadSignalsForDate(date) {
    if (date) {
        window.location.href = `{{ url_for('dashboard_trading_signals') }}?date=${date}`;
    }
}

function startLiveUpdates() {
    if (isLiveMode) {
        // Auto-refresh signals every 2 minutes during market hours
        autoRefreshInterval = setInterval(function() {
            if (document.hasFocus() && isMarketHours()) {
                console.log('targetcapital.ai says: Auto-refreshing trading signals...');
                refreshSignals();
            }
        }, 120000); // 2 minutes
    }
}

function updateLiveIndicator() {
    const indicator = document.getElementById('live-indicator');
    if (isMarketHours()) {
        indicator.className = 'badge bg-success ms-2';
        indicator.innerHTML = '<i class="fas fa-circle me-1"></i>Live';
    } else {
        indicator.className = 'badge bg-secondary ms-2';
        indicator.innerHTML = '<i class="fas fa-clock me-1"></i>After Hours';
    }
}

function isMarketHours() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const timeInMinutes = hours * 60 + minutes;
    
    // Market hours: 9:15 AM to 3:30 PM (IST)
    const marketOpen = 9 * 60 + 15; // 9:15 AM
    const marketClose = 15 * 60 + 30; // 3:30 PM
    
    return timeInMinutes >= marketOpen && timeInMinutes <= marketClose;
}

// Keyboard shortcuts for quick actions
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'r':
                e.preventDefault();
                refreshSignals();
                break;
            case '1':
                e.preventDefault();
                filterSignals('all');
                break;
            case '2':
                e.preventDefault();
                filterSignals('stock');
                break;
            case '3':
                e.preventDefault();
                filterSignals('option');
                break;
        }
    }
});

// Add responsive handling for mobile
if (window.innerWidth <= 768) {
    // Hide less important columns on mobile
    const hideOnMobile = ['Type', 'Return', 'Risk'];
    hideOnMobile.forEach(header => {
        const th = Array.from(document.querySelectorAll('th')).find(el => el.textContent.trim() === header);
        if (th) {
            const index = Array.from(th.parentNode.children).indexOf(th);
            document.querySelectorAll(`tr td:nth-child(${index + 1}), tr th:nth-child(${index + 1})`).forEach(cell => {
                cell.style.display = 'none';
            });
        }
    });
}

// AI Stock Picker Functions
function generatePerplexityPicks() {
    console.log('Generating Perplexity AI picks...');
    
    // Show loading state
    document.getElementById('researchLoading').style.display = 'block';
    document.getElementById('researchResults').style.display = 'none';
    
    // Scroll to loading section
    document.getElementById('researchLoading').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    fetch('/api/ai/perplexity-picks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            market: 'NSE',
            limit: 5
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('researchLoading').style.display = 'none';
        
        if (data.success) {
            document.getElementById('researchResultsBody').innerHTML = data.research_data;
            document.getElementById('researchResults').style.display = 'block';
            
            // Scroll to results
            document.getElementById('researchResults').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Refresh AI picks after generating research
            setTimeout(() => {
                location.reload(); // Reload to show new picks
            }, 3000);
        } else {
            alert('Error generating AI picks: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('researchLoading').style.display = 'none';
        alert('Failed to generate AI picks. Please try again.');
    });
}

function generateAIRecommendations() {
    generatePerplexityPicks();
}

function loadAIPicksForDate(selectedDate) {
    // Reload page with selected date
    const url = new URL(window.location);
    url.searchParams.set('date', selectedDate);
    window.location.href = url.toString();
}

function refreshStockPrices() {
    // Add spinning animation to refresh button
    const refreshBtn = event.target.closest('button');
    const icon = refreshBtn.querySelector('i');
    icon.classList.add('fa-spin');
    
    // Simulate refresh - in production this would update prices
    setTimeout(() => {
        icon.classList.remove('fa-spin');
        // You could add actual price refresh logic here
    }, 2000);
}

function tradeStock(symbol, action, price, companyName) {
    // Redirect to Trade Now page with prefilled data
    const url = `/dashboard/trade-now?symbol=${encodeURIComponent(symbol)}&action=${action}&price=${price}&name=${encodeURIComponent(companyName)}`;
    window.location.href = url;
}

function viewDetailedAnalysis(symbol) {
    // Open detailed analysis page
    window.open(`/dashboard/detailed-analysis/${symbol}`, '_blank');
}

function addToWatchlist(symbol) {
    fetch('/api/watchlist/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            symbol: symbol
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${symbol} added to watchlist!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        } else {
            alert('Error adding to watchlist: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add to watchlist. Please try again.');
    });
}

// AI Research Form Handler
document.addEventListener('DOMContentLoaded', function() {
    const aiResearchForm = document.getElementById('aiResearchForm');
    if (aiResearchForm) {
        aiResearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            runAIAnalysis();
        });
    }
    
    // Toggle icon rotation
    const aiResearchPanel = document.getElementById('aiResearchPanel');
    if (aiResearchPanel) {
        aiResearchPanel.addEventListener('shown.bs.collapse', function() {
            document.getElementById('aiResearchToggleIcon').style.transform = 'rotate(180deg)';
        });
        aiResearchPanel.addEventListener('hidden.bs.collapse', function() {
            document.getElementById('aiResearchToggleIcon').style.transform = 'rotate(0deg)';
        });
    }
});

function runAIAnalysis() {
    const assetType = document.getElementById('assetType').value;
    const symbol = document.getElementById('symbolSearch').value.trim().toUpperCase();
    const dateFrom = document.getElementById('analysisFromDate').value;
    const dateTo = document.getElementById('analysisToDate').value;
    
    if (!symbol) {
        alert('Please enter a symbol or asset name to analyse.');
        return;
    }
    
    // Show loading state
    document.getElementById('analysisLoading').style.display = 'block';
    document.getElementById('analysisResultsPanel').style.display = 'none';
    document.getElementById('analyseBtn').disabled = true;
    document.getElementById('analyseBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    
    // Simulate pipeline stages
    const stages = ['Preparing context...', 'Analysing qualitative sentiment...', 'Processing quantitative data...', 
                    'Checking search trends...', 'Analysing market trends...', 'Aggregating scores...', 'Generating recommendation...'];
    let stageIndex = 0;
    const stageInterval = setInterval(() => {
        if (stageIndex < stages.length) {
            document.getElementById('pipelineStage').textContent = stages[stageIndex];
            stageIndex++;
        }
    }, 1500);
    
    // Call API
    fetch('/api/ai-research/analyse', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            asset_type: assetType,
            symbol: symbol,
            date_from: dateFrom,
            date_to: dateTo
        })
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(stageInterval);
        document.getElementById('analysisLoading').style.display = 'none';
        document.getElementById('analyseBtn').disabled = false;
        document.getElementById('analyseBtn').innerHTML = '<i class="fas fa-robot me-2"></i>Generate AI Signals';
        
        if (data.success) {
            displayAnalysisResults(data);
        } else {
            alert('Analysis failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        clearInterval(stageInterval);
        console.error('Analysis error:', error);
        document.getElementById('analysisLoading').style.display = 'none';
        document.getElementById('analyseBtn').disabled = false;
        document.getElementById('analyseBtn').innerHTML = '<i class="fas fa-robot me-2"></i>Generate AI Signals';
        alert('Failed to run analysis. Please try again.');
    });
}

function displayAnalysisResults(data) {
    document.getElementById('analysisResultsPanel').style.display = 'block';
    
    // Update overall score
    const score = Math.round(data.overall_score || 0);
    const scorePct = score + '%';
    const scoreCircle = document.getElementById('overallScoreCircle');
    scoreCircle.style.setProperty('--score-pct', scorePct);
    scoreCircle.style.background = `conic-gradient(${getScoreColor(data.recommendation)} ${scorePct}, #e5e7eb 0%)`;
    document.getElementById('overallScoreValue').textContent = score;
    
    // Update recommendation badge
    const recBadge = document.getElementById('recommendationBadge');
    const recClass = getRecommendationClass(data.recommendation);
    const recText = formatRecommendation(data.recommendation);
    recBadge.innerHTML = `<span class="badge ${recClass} fs-6">${recText}</span>`;
    
    // Update confidence
    const confidence = Math.round((data.confidence || 0) * 100);
    document.getElementById('confidenceText').textContent = `Confidence: ${confidence}%`;
    
    // Update component scores and detailed content
    if (data.component_scores) {
        data.component_scores.forEach(comp => {
            const rawScore = Math.round(comp.raw_score || 0);
            const signal = comp.signal || 'neutral';
            const signalBadgeClass = getSignalBadgeClass(signal);
            
            if (comp.type === 'qualitative') {
                document.getElementById('qualScore').textContent = rawScore + '/100';
                document.getElementById('qualProgress').style.width = rawScore + '%';
                document.getElementById('qualSignalBadge').textContent = signal.toUpperCase();
                document.getElementById('qualSignalBadge').className = 'badge ' + signalBadgeClass + ' ms-auto me-2';
                document.getElementById('qualitativeContent').innerHTML = formatDetailedAnalysis(comp, 'qualitative', data);
            } else if (comp.type === 'quantitative') {
                document.getElementById('quantScore').textContent = rawScore + '/100';
                document.getElementById('quantProgress').style.width = rawScore + '%';
                document.getElementById('quantSignalBadge').textContent = signal.toUpperCase();
                document.getElementById('quantSignalBadge').className = 'badge ' + signalBadgeClass + ' ms-auto me-2';
                document.getElementById('quantitativeContent').innerHTML = formatDetailedAnalysis(comp, 'quantitative', data);
            } else if (comp.type === 'search') {
                document.getElementById('searchScore').textContent = rawScore + '/100';
                document.getElementById('searchProgress').style.width = rawScore + '%';
                document.getElementById('searchSignalBadge').textContent = signal.toUpperCase();
                document.getElementById('searchSignalBadge').className = 'badge ' + signalBadgeClass + ' ms-auto me-2';
                document.getElementById('searchContent').innerHTML = formatDetailedAnalysis(comp, 'search', data);
            } else if (comp.type === 'trend') {
                document.getElementById('trendScore').textContent = rawScore + '/100';
                document.getElementById('trendProgress').style.width = rawScore + '%';
                document.getElementById('trendSignalBadge').textContent = signal.toUpperCase();
                document.getElementById('trendSignalBadge').className = 'badge ' + signalBadgeClass + ' ms-auto me-2';
                document.getElementById('trendContent').innerHTML = formatDetailedAnalysis(comp, 'trend', data);
            }
        });
    }
    
    // Update summary
    document.getElementById('summaryText').textContent = data.recommendation_summary || 'Analysis complete.';
}

function getSignalBadgeClass(signal) {
    const classes = {
        'bullish': 'bg-success',
        'bearish': 'bg-danger',
        'neutral': 'bg-secondary',
        'strong_bullish': 'bg-success',
        'strong_bearish': 'bg-danger'
    };
    return classes[signal.toLowerCase()] || 'bg-secondary';
}

function formatDetailedAnalysis(comp, type, data) {
    const rawScore = Math.round(comp.raw_score || 0);
    const weightedScore = Math.round(comp.weighted_score || 0);
    const weight = comp.weight_pct || 0;
    const signal = comp.signal || 'neutral';
    const confidence = Math.round((comp.confidence || 0) * 100);
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card bg-light border-0">
                    <div class="card-body p-3 text-center">
                        <h4 class="mb-0 text-primary">${rawScore}</h4>
                        <small class="text-muted">Raw Score</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light border-0">
                    <div class="card-body p-3 text-center">
                        <h4 class="mb-0 text-info">${weightedScore}</h4>
                        <small class="text-muted">Weighted (${weight}%)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light border-0">
                    <div class="card-body p-3 text-center">
                        <h4 class="mb-0 text-success">${confidence}%</h4>
                        <small class="text-muted">Confidence</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <strong>Signal Direction:</strong> 
            <span class="badge ${getSignalBadgeClass(signal)}">${signal.toUpperCase()}</span>
        </div>
    `;
    
    // Add type-specific details
    if (type === 'qualitative') {
        html += `
            <div class="alert alert-info border-0 small mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>News & Social Sentiment:</strong> Analysis of recent news articles, social media discussions, and market commentary for ${data.symbol || 'the asset'}. 
                Factors include analyst ratings, earnings reports sentiment, and institutional activity signals.
            </div>
        `;
    } else if (type === 'quantitative') {
        html += `
            <div class="alert alert-primary border-0 small mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                <strong>Technical Indicators:</strong> 
                <ul class="mb-0 mt-2">
                    <li><strong>RSI (14):</strong> Momentum oscillator measuring overbought/oversold conditions</li>
                    <li><strong>SuperTrend:</strong> Trend-following indicator for direction and support/resistance</li>
                    <li><strong>EMA Crossover:</strong> 9/20 period exponential moving average signals</li>
                    <li><strong>Volume Analysis:</strong> Trading volume patterns and accumulation/distribution</li>
                </ul>
            </div>
        `;
    } else if (type === 'search') {
        html += `
            <div class="alert alert-warning border-0 small mb-0">
                <i class="fas fa-search me-2"></i>
                <strong>Search Trends & Interest:</strong> Analysis of Google Trends data, Perplexity search queries, 
                and retail investor interest metrics for ${data.symbol || 'the asset'}. Higher search volume often correlates with increased volatility.
            </div>
        `;
    } else if (type === 'trend') {
        html += `
            <div class="alert alert-success border-0 small mb-0">
                <i class="fas fa-chart-line me-2"></i>
                <strong>Market Trend Indicators:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>Open Interest (OI):</strong> Derivatives market positioning and sentiment</li>
                    <li><strong>Put-Call Ratio (PCR):</strong> Options market sentiment indicator</li>
                    <li><strong>VIX Correlation:</strong> Volatility index impact assessment</li>
                    <li><strong>Sector Momentum:</strong> Relative strength within sector peers</li>
                </ul>
            </div>
        `;
    }
    
    return html;
}

function getScoreColor(recommendation) {
    const colors = {
        'strong_buy': '#10b981',
        'buy': '#3b82f6',
        'hold': '#6b7280',
        'cautionary_sell': '#f59e0b',
        'strong_sell': '#ef4444',
        'inconclusive': '#9ca3af'
    };
    return colors[recommendation] || '#6b7280';
}

function getRecommendationClass(recommendation) {
    const classes = {
        'strong_buy': 'bg-success',
        'buy': 'bg-primary',
        'hold': 'bg-secondary',
        'cautionary_sell': 'bg-warning text-dark',
        'strong_sell': 'bg-danger',
        'inconclusive': 'bg-light text-dark'
    };
    return classes[recommendation] || 'bg-secondary';
}

function formatRecommendation(recommendation) {
    const labels = {
        'strong_buy': 'STRONG BUY',
        'buy': 'BUY',
        'hold': 'HOLD',
        'cautionary_sell': 'CAUTIONARY SELL',
        'strong_sell': 'STRONG SELL',
        'inconclusive': 'INCONCLUSIVE'
    };
    return labels[recommendation] || recommendation.toUpperCase();
}
</script>

<style>
/* Enhanced table styling for better readability */
.table > tbody > tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.signal-row {
    cursor: pointer;
    transition: all 0.2s ease;
}

.sticky-top {
    z-index: 1020;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
        max-width: 100vw;
        min-height: 500px;
    }
    
    .table {
        min-width: 1200px;
        width: auto;
    }
    
    .btn-group .btn {
        padding: 0.25rem 0.5rem;
    }
    
    .badge {
        font-size: 0.7rem;
    }
}

/* Live indicator animation */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

#live-indicator.bg-success {
    animation: pulse 2s infinite;
}

/* Additional styles for AI Stock Picker section */
.ai-section-divider {
    border-top: 2px solid #e9ecef;
    margin: 2rem 0;
}

/* Enhanced empty state */
.text-primary.opacity-50 {
    opacity: 0.4 !important;
}

/* Improved data source indicators */
.text-muted.small span {
    white-space: nowrap;
}

@media (max-width: 768px) {
    .d-flex.flex-wrap.gap-2.text-muted.small {
        justify-content: center;
        text-align: center;
    }
}

/* Loading animation */
@keyframes aiPulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.fa-sync-alt.fa-spin {
    animation: spin 1s linear infinite;
}

/* Hover effects for action buttons */
.btn-outline-success:hover,
.btn-outline-primary:hover,
.btn-outline-info:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}

/* AI Stock Picker specific table styling */
.ai-picks-table {
    overflow-x: hidden;
}

/* Ensure table doesn't overflow */
.ai-picks-table .table-responsive {
    -webkit-overflow-scrolling: touch;
    overflow-x: hidden;
    margin-bottom: 0;
}

/* Compact table styling for AI picks */
.ai-picks-table .table td,
.ai-picks-table .table th {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 0;
}

.ai-picks-table .table .btn-group .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
    border-width: 1px;
}

/* Fix button groups on small screens for AI picks */
@media (max-width: 575.98px) {
    .ai-picks-table .btn-group .btn {
        padding: 0.25rem 0.4rem;
        margin: 0 1px;
    }
    
    .ai-picks-table .d-flex.flex-wrap.gap-1 {
        gap: 0.25rem !important;
    }
}
</style>
{% endblock %}