{% extends "base.html" %}

{% block navbar %}
<!-- Dashboard Navigation - Simplified -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top border-bottom" style="padding: 20px 0; border-bottom: 1px solid #e9ecef !important; background-color: #ffffff !important;">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}" style="font-weight: 600;">
            <img src="{{ url_for('static', filename='images/logo.png') }}?v=3" 
                 alt="Target Capital Logo" height="70" class="me-0">
        </a>
        
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" style="padding: 0.25rem 0.5rem;">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <!-- Right-aligned User Menu Only -->
            <div class="d-flex align-items-center ms-auto">
                {% if current_user.is_authenticated %}
                    <!-- Authenticated User Menu -->
                    <div class="dropdown">
                        <a class="text-decoration-none text-dark d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: 500; font-size: 15px;">
                            <i class="fas fa-user-circle me-2 text-primary"></i>{{ current_user.get_full_name() }}
                            <i class="fas fa-chevron-down ms-2" style="font-size: 12px;"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="userDropdown" style="border-radius: 8px; padding: 8px 0;">
                            <li><a class="dropdown-item py-2" href="{{ url_for('dashboard') }}" style="font-size: 14px;">
                                <i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard
                            </a></li>
                            <li><hr class="dropdown-divider my-1"></li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('account_profile') }}" style="font-size: 14px;">
                                <i class="fas fa-user me-2 text-muted"></i>Profile
                            </a></li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('account_billing') }}" style="font-size: 14px;">
                                <i class="fas fa-credit-card me-2 text-muted"></i>Billing
                            </a></li>
                            <li class="px-3 py-1">
                                <small class="text-muted">Current Plan:</small><br>
                                <small class="fw-bold text-primary">{{ current_user.get_plan_display_name() }}</small>
                                {% if not current_user.is_subscription_active() and current_user.pricing_plan.name != 'FREE' %}
                                <span class="badge bg-warning ms-1">Expired</span>
                                {% endif %}
                            </li>
                            <li><hr class="dropdown-divider my-1"></li>
                            <li><a class="dropdown-item py-2 text-danger" href="{{ url_for('logout') }}" style="font-size: 14px;">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="dashboard-app">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle d-lg-none" id="mobileMenuToggle" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Navigation -->
    <aside class="dashboard-sidebar" id="dashboardSidebar">
        {% include 'dashboard/sidebar.html' %}
    </aside>

    <!-- Main Content Area -->
    <main class="dashboard-main">
        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-title">
                    <h1>{% block dashboard_title %}Dashboard{% endblock %}</h1>
                    <p class="header-subtitle">{% block dashboard_subtitle %}Your personalized AI-powered trading dashboard{% endblock %}</p>
                </div>
                <div class="header-actions">
                    <!-- Subtle Signal Indicator -->
                    <div class="signal-indicator" id="signalIndicator" style="display: none;">
                        <button class="btn btn-sm btn-outline-success position-relative" onclick="toggleSignalPanel()" title="New high-confidence signals available">
                            <i class="fas fa-signal me-1"></i>
                            <span class="signal-count">0</span>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" id="signalBadge">
                                0
                                <span class="visually-hidden">new signals</span>
                            </span>
                        </button>
                    </div>
                    {% block dashboard_toolbar %}{% endblock %}
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <section class="dashboard-content">
            <div class="content-container">
                {% block dashboard_content %}{% endblock %}
            </div>
        </section>
    </main>

    <!-- Mobile Sidebar Overlay -->
    <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>
    
    <!-- Non-intrusive Signal Panel -->
    <div class="signal-panel" id="signalPanel" style="display: none;">
        <div class="signal-panel-header">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    High-Confidence Signals
                </h6>
                <button class="btn btn-sm btn-link text-muted" onclick="toggleSignalPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="signal-panel-content" id="signalPanelContent">
            <div class="text-center text-muted py-3">
                <i class="fas fa-signal fa-2x mb-2"></i>
                <p>No new high-confidence signals</p>
            </div>
        </div>
        <div class="signal-panel-footer">
            <div class="d-flex gap-2">
                <a href="{{ url_for('dashboard_trading_signals') }}" class="btn btn-sm btn-outline-primary flex-fill">
                    <i class="fas fa-list me-1"></i>View All Signals
                </a>
                <button class="btn btn-sm btn-outline-secondary" onclick="markSignalsRead()">
                    <i class="fas fa-check me-1"></i>Mark Read
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upgrade Alert Modal -->
<div class="modal fade" id="upgradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upgrade Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                    <h5>This feature requires a higher subscription plan</h5>
                    <p class="text-muted" id="upgradeMessage">Upgrade your account to access this feature and unlock the full power of our AI-powered trading platform.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{{ url_for('account_billing') }}" class="btn btn-primary">Upgrade Now</a>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard Layout Management
class DashboardLayout {
    constructor() {
        this.sidebar = document.getElementById('dashboardSidebar');
        this.overlay = document.getElementById('mobileSidebarOverlay');
        this.menuToggle = document.getElementById('mobileMenuToggle');
        this.init();
    }

    init() {
        this.bindEvents();
        this.handleResize();
        window.addEventListener('resize', () => this.handleResize());
    }

    bindEvents() {
        // Mobile menu toggle
        if (this.menuToggle) {
            this.menuToggle.addEventListener('click', () => this.toggleMobileSidebar());
        }
        
        // Click outside signal panel to close it
        document.addEventListener('click', (e) => {
            const signalPanel = document.getElementById('signalPanel');
            const signalIndicator = document.getElementById('signalIndicator');
            
            if (signalPanel && signalPanel.style.display !== 'none' && 
                !signalPanel.contains(e.target) && 
                !signalIndicator.contains(e.target)) {
                this.hideSignalPanel();
            }
        });
    }
    
    hideSignalPanel() {
        const panel = document.getElementById('signalPanel');
        if (panel) {
            panel.style.display = 'none';
        }
    }

        // Overlay click to close
        if (this.overlay) {
            this.overlay.addEventListener('click', () => this.closeMobileSidebar());
        }

        // Escape key to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeMobileSidebar();
            }
        });

        // Close sidebar when clicking nav links on mobile
        const navLinks = this.sidebar?.querySelectorAll('.nav-link');
        navLinks?.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 992) {
                    this.closeMobileSidebar();
                }
            });
        });
    }

    toggleMobileSidebar() {
        if (this.sidebar?.classList.contains('show')) {
            this.closeMobileSidebar();
        } else {
            this.openMobileSidebar();
        }
    }

    openMobileSidebar() {
        this.sidebar?.classList.add('show');
        this.overlay?.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    closeMobileSidebar() {
        this.sidebar?.classList.remove('show');
        this.overlay?.classList.remove('show');
        document.body.style.overflow = '';
    }

    handleResize() {
        if (window.innerWidth >= 992) {
            this.closeMobileSidebar();
        }
    }
}

// Upgrade Alert Function
function showUpgradeAlert(requiredPlan = 'Target Plus') {
    const messages = {
        'Target Plus': 'Upgrade to Target Plus plan (₹1,499/month) to access this feature.',
        'Target Pro': 'Upgrade to Target Pro plan (₹2,499/month) to access this feature.'
    };
    
    document.getElementById('upgradeMessage').textContent = messages[requiredPlan] || messages['Target Plus'];
    
    const upgradeModal = new bootstrap.Modal(document.getElementById('upgradeModal'));
    upgradeModal.show();
}

// Initialize Dashboard Layout
document.addEventListener('DOMContentLoaded', () => {
    window.dashboardLayout = new DashboardLayout();
    window.signalManager = new SignalManager();
});

// Non-intrusive Signal Management
class SignalManager {
    constructor() {
        this.highConfidenceSignals = [];
        this.isSignalPanelVisible = false;
        this.init();
    }
    
    init() {
        this.bindSignalEvents();
        this.checkForSignals();
    }
    
    bindSignalEvents() {
        // Listen for new trading signals from dashboard app
        if (typeof window.dashboardApp !== 'undefined' && window.dashboardApp.on) {
            window.dashboardApp.on('tradingSignal', (signal) => {
                this.handleNewSignal(signal);
            });
        }
        
        // Listen for signals from react-dashboard if available
        if (typeof window.ReactDashboard !== 'undefined') {
            const reactDashboard = window.ReactDashboard;
            if (reactDashboard && reactDashboard.on) {
                reactDashboard.on('tradingSignal', (signal) => {
                    this.handleNewSignal(signal);
                });
            }
        }
    }
    
    handleNewSignal(signal) {
        // Only show high-confidence signals (80%+) in the non-intrusive display
        if (signal && signal.confidence >= 80) {
            // Add timestamp if not present
            if (!signal.timestamp) {
                signal.timestamp = new Date().toISOString();
            }
            
            this.highConfidenceSignals.unshift(signal);
            
            // Keep only the latest 10 high-confidence signals
            if (this.highConfidenceSignals.length > 10) {
                this.highConfidenceSignals.splice(10);
            }
            
            this.updateSignalIndicator();
            this.addSubtleVisualCue();
        }
    }
    
    updateSignalIndicator() {
        const indicator = document.getElementById('signalIndicator');
        const badge = document.getElementById('signalBadge');
        const countSpan = indicator?.querySelector('.signal-count');
        
        if (this.highConfidenceSignals.length > 0) {
            if (indicator) {
                indicator.style.display = 'block';
                indicator.classList.add('has-new-signals');
            }
            if (badge) {
                badge.textContent = this.highConfidenceSignals.length;
            }
            if (countSpan) {
                countSpan.textContent = this.highConfidenceSignals.length;
            }
        } else {
            if (indicator) {
                indicator.style.display = 'none';
                indicator.classList.remove('has-new-signals');
            }
        }
    }
    
    addSubtleVisualCue() {
        const indicator = document.getElementById('signalIndicator');
        if (indicator) {
            indicator.classList.add('has-new-signals');
            
            // Optional very subtle sound
            this.playSubtleNotificationSound();
        }
    }
    
    playSubtleNotificationSound() {
        try {
            // Only play if user has interacted with page (browser requirement)
            if (document.visibilityState === 'visible') {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Very gentle, low-volume notification (barely audible)
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.02, audioContext.currentTime); // Extremely quiet
                gainNode.gain.exponentialRampToValueAtTime(0.005, audioContext.currentTime + 0.1);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            }
        } catch (error) {
            // Silently fail if audio context is not supported
        }
    }
    
    renderSignalPanelContent() {
        const content = document.getElementById('signalPanelContent');
        if (!content) return;
        
        if (this.highConfidenceSignals.length === 0) {
            content.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-signal fa-2x mb-2"></i><p>No new high-confidence signals</p></div>';
            return;
        }
        
        const signalsHtml = this.highConfidenceSignals.map(signal => {
            const actionClass = signal.action === 'BUY' ? 'success' : signal.action === 'SELL' ? 'danger' : 'secondary';
            return '<div class="signal-item">' +
                '<div class="d-flex justify-content-between align-items-start mb-2">' +
                '<div>' +
                '<strong class="text-dark">' + signal.symbol + '</strong>' +
                '<span class="badge bg-' + actionClass + ' ms-2">' + signal.action + '</span>' +
                '</div>' +
                '<div class="text-end">' +
                '<div class="signal-confidence high">' + Math.round(signal.confidence) + '%</div>' +
                '<div class="signal-meta">' + this.formatTimeAgo(signal.timestamp) + '</div>' +
                '</div>' +
                '</div>' +
                '<div class="signal-meta">' +
                (signal.entry_price ? 'Entry: ₹' + signal.entry_price : '') +
                (signal.target_price ? ' • Target: ₹' + signal.target_price : '') +
                '</div>' +
                '</div>';
        }).join('');
        
        content.innerHTML = signalsHtml;
    }
    
    formatTimeAgo(timestamp) {
        const now = new Date();
        const diff = now - new Date(timestamp);
        const minutes = Math.floor(diff / 60000);
        
        if (minutes < 1) return 'Just now';
        if (minutes < 60) return minutes + 'm ago';
        
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return hours + 'h ago';
        
        const days = Math.floor(hours / 24);
        return days + 'd ago';
    }
    
    markSignalsRead() {
        this.highConfidenceSignals = [];
        this.updateSignalIndicator();
        this.hideSignalPanel();
    }
    
    checkForSignals() {
        // Initialize with empty state - signals will come from WebSocket or API
        this.updateSignalIndicator();
    }
    
    showSignalPanel() {
        const panel = document.getElementById('signalPanel');
        if (panel) {
            this.renderSignalPanelContent();
            panel.style.display = 'block';
            this.isSignalPanelVisible = true;
        }
    }
    
    hideSignalPanel() {
        const panel = document.getElementById('signalPanel');
        if (panel) {
            panel.style.display = 'none';
            this.isSignalPanelVisible = false;
        }
    }
}

// Global functions for onclick handlers
function toggleSignalPanel() {
    if (window.signalManager) {
        if (window.signalManager.isSignalPanelVisible) {
            window.signalManager.hideSignalPanel();
        } else {
            window.signalManager.showSignalPanel();
        }
    }
}

function markSignalsRead() {
    if (window.signalManager) {
        window.signalManager.markSignalsRead();
    }
}

// Demo function to test the non-intrusive signal system
function demoSignalNotification() {
    if (window.signalManager) {
        const demoSignal = {
            symbol: 'RELIANCE',
            action: 'BUY',
            confidence: 85,
            entry_price: '2450.00',
            target_price: '2600.00',
            timestamp: new Date().toISOString()
        };
        window.signalManager.handleNewSignal(demoSignal);
    }
}

// Add demo button only in development - remove in production
if (window.location.hostname === 'localhost' || window.location.hostname.includes('replit')) {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            const headerActions = document.querySelector('.header-actions');
            if (headerActions) {
                const demoBtn = document.createElement('button');
                demoBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
                demoBtn.innerHTML = '<i class="fas fa-flask me-1"></i>Demo Signal';
                demoBtn.onclick = demoSignalNotification;
                demoBtn.title = 'Test the non-intrusive signal display';
                headerActions.appendChild(demoBtn);
            }
        }, 1000);
    });
}
</script>

<style>
/* Dashboard Layout System */
.dashboard-app {
    display: flex;
    min-height: 100vh;
    background-color: #f8fafc;
    width: 100%;
    overflow-x: hidden;
}

/* Mobile Menu Toggle */
.mobile-menu-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1050;
    background: #00091a;
    color: white;
    border: none;
    border-radius: 8px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 9, 26, 0.15);
    transition: all 0.3s ease;
}

.mobile-menu-toggle:hover {
    background: #001122;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 9, 26, 0.25);
}

@media (min-width: 992px) {
    .mobile-menu-toggle {
        display: none;
    }
}

/* Sidebar */
.dashboard-sidebar {
    width: 280px;
    background: #f8f9fa;
    color: #2d3748;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    overflow-y: auto;
    z-index: 1040;
    transition: transform 0.3s ease;
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.1) transparent;
    border-right: 1px solid #e2e8f0;
}

.dashboard-sidebar::-webkit-scrollbar {
    width: 6px;
}

.dashboard-sidebar::-webkit-scrollbar-track {
    background: transparent;
}

.dashboard-sidebar::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
}

@media (max-width: 991.98px) {
    .dashboard-sidebar {
        transform: translateX(-100%);
    }
    
    .dashboard-sidebar.show {
        transform: translateX(0);
    }
}

/* Main Content */
.dashboard-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-left: 280px;
    min-height: 100vh;
    width: calc(100% - 280px);
    max-width: 100%;
}

@media (max-width: 991.98px) {
    .dashboard-main {
        margin-left: 0;
        width: 100%;
    }
}

/* Dashboard Header */
.dashboard-header {
    background: white;
    border-bottom: 1px solid #e2e8f0;
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 1020;
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 20px;
    min-height: 70px;
}

@media (max-width: 768px) {
    .header-content {
        padding: 16px 12px;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
}

.header-title h1 {
    font-size: 28px;
    font-weight: 700;
    color: #1a202c;
    margin: 0 0 4px 0;
    line-height: 1.2;
}

.header-subtitle {
    font-size: 14px;
    color: #718096;
    margin: 0;
    font-weight: 400;
}

@media (max-width: 768px) {
    .header-title h1 {
        font-size: 24px;
    }
    
    .header-subtitle {
        font-size: 13px;
    }
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

@media (max-width: 768px) {
    .header-actions {
        width: 100%;
        justify-content: flex-end;
    }
}

/* Dashboard Content */
.dashboard-content {
    flex: 1;
    padding: 20px;
    overflow-x: hidden;
}

@media (max-width: 768px) {
    .dashboard-content {
        padding: 16px 12px;
    }
}

.content-container {
    width: 100%;
    max-width: none;
}

/* Mobile Sidebar Overlay */
.mobile-sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1030;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.mobile-sidebar-overlay.show {
    opacity: 1;
    visibility: visible;
}

@media (min-width: 992px) {
    .mobile-sidebar-overlay {
        display: none;
    }
}

/* Grid System for Dashboard Content */
.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    margin-bottom: 20px;
    width: 100%;
}

@media (min-width: 768px) {
    .dashboard-grid.cols-2 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-grid.cols-3 {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .dashboard-grid.cols-4 {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (min-width: 1200px) {
    .dashboard-grid.cols-auto {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
}

/* Card Components */
.dashboard-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    overflow: hidden;
    transition: all 0.3s ease;
}

.dashboard-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.card-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
}

.card-header h3 {
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
    margin: 0;
}

.card-body {
    padding: 20px;
}

.card-footer {
    padding: 14px 20px;
    border-top: 1px solid #e2e8f0;
    background: #f8fafc;
}

/* Utility Classes */
.text-overflow {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.flex-center {
    display: flex;
    align-items: center;
    justify-content: center;
}

.flex-between {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.flex-start {
    display: flex;
    align-items: center;
    justify-content: flex-start;
}

/* Responsive Utilities */
@media (max-width: 575.98px) {
    .d-none-sm {
        display: none !important;
    }
}

@media (max-width: 767.98px) {
    .d-none-md {
        display: none !important;
    }
}

@media (max-width: 991.98px) {
    .d-none-lg {
        display: none !important;
    }
}

/* Performance Optimizations */
.dashboard-app * {
    box-sizing: border-box;
}

.dashboard-content {
    will-change: scroll-position;
}

.dashboard-sidebar {
    will-change: transform;
}

/* Accessibility */
.mobile-menu-toggle:focus {
    outline: 2px solid #4299e1;
    outline-offset: 2px;
}

.dashboard-card:focus-within {
    outline: 2px solid #4299e1;
    outline-offset: 2px;
}

/* Reduce motion for accessibility */
@media (prefers-reduced-motion: reduce) {
    .dashboard-sidebar,
    .mobile-sidebar-overlay,
    .dashboard-card,
    .mobile-menu-toggle {
        transition: none;
    }
}
</style>
{% endblock %}