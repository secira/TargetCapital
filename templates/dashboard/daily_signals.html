{% extends "dashboard/dashboard_base.html" %}

{% block title %}Daily Signals - Target Capital Dashboard{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block extra_css %}
<style>
/* Override dashboard content container to allow full width */
.dashboard-main .dashboard-content .content-container {
    max-width: none !important;
    width: 100% !important;
    margin: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
}

.dashboard-main .dashboard-content .content-container > .container-fluid {
    padding-left: 0 !important;
    padding-right: 0 !important;
}

.daily-signals-page,
.daily-signals-page * {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-weight: 300;
}

.daily-signals-page {
    font-size: 14px;
    letter-spacing: -0.01em;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
}

.daily-signals-page h1, 
.daily-signals-page h2, 
.daily-signals-page h3, 
.daily-signals-page h4, 
.daily-signals-page h5, 
.daily-signals-page h6 {
    font-weight: 500;
    letter-spacing: -0.02em;
}

.daily-signals-page .form-control,
.daily-signals-page .form-select,
.daily-signals-page .btn {
    font-family: 'Inter', sans-serif;
    font-weight: 400;
}

.daily-signals-page .card {
    width: 100% !important;
    max-width: 100% !important;
}

.daily-signals-page .table-responsive {
    width: 100% !important;
    overflow-x: auto;
}

.daily-signals-page .filter-section {
    width: 100% !important;
}

.signal-card {
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
    overflow: hidden;
}

.signal-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.signal-header {
    padding: 16px 20px;
    background: linear-gradient(135deg, #00091a 0%, #1a365d 100%);
    color: white;
}

.signal-body {
    padding: 20px;
}

.signal-action-buy {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
}

.signal-action-sell {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
}

.price-tag {
    background: #f3f4f6;
    padding: 8px 16px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.price-tag.entry {
    background: #ecfdf5;
    color: #059669;
}

.price-tag.sl {
    background: #fef2f2;
    color: #dc2626;
}

.price-tag.target {
    background: #eff6ff;
    color: #2563eb;
}

.target-list {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.outcome-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.outcome-target-hit {
    background: #dcfce7;
    color: #166534;
}

.outcome-sl-hit {
    background: #fee2e2;
    color: #991b1b;
}

.outcome-early-exit {
    background: #fef3c7;
    color: #92400e;
}

.outcome-active {
    background: #dbeafe;
    color: #1e40af;
}

.filter-section {
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.date-nav {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.date-btn {
    padding: 8px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
}

.date-btn:hover {
    border-color: #3b82f6;
    color: #3b82f6;
}

.date-btn.active {
    background: #00091a;
    color: white;
    border-color: #00091a;
}

.summary-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e5e7eb;
    text-align: center;
}

.summary-value {
    font-size: 28px;
    font-weight: 700;
    color: #1a202c;
}

.summary-label {
    font-size: 13px;
    color: #6b7280;
    margin-top: 4px;
}

.points-positive {
    color: #059669 !important;
}

.points-negative {
    color: #dc2626 !important;
}

.signal-table {
    width: 100% !important;
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    table-layout: auto;
}

.signal-table thead th {
    background: #f8fafc;
    padding: 12px 10px;
    text-align: left;
    font-weight: 500;
    font-size: 12px;
    color: #4a5568;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
}

/* Column width distribution */
.signal-table thead th:nth-child(1) { width: 8%; }   /* Asset Type */
.signal-table thead th:nth-child(2) { width: 14%; }  /* Asset Name */
.signal-table thead th:nth-child(3) { width: 9%; }   /* Expiry Date */
.signal-table thead th:nth-child(4) { width: 10%; }  /* Current Price */
.signal-table thead th:nth-child(5) { width: 9%; }   /* Entry Price */
.signal-table thead th:nth-child(6) { width: 9%; }   /* Target 1 */
.signal-table thead th:nth-child(7) { width: 9%; }   /* Target 2 */
.signal-table thead th:nth-child(8) { width: 9%; }   /* Stop Loss */
.signal-table thead th:nth-child(9) { width: 9%; }   /* Duration */
.signal-table thead th:nth-child(10) { width: 7%; }  /* Risk Level */
.signal-table thead th:nth-child(11) { width: 7%; }  /* Action */

.signal-table tbody td {
    padding: 12px 10px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
    font-weight: 300;
    font-size: 13px;
}

.signal-table tbody tr:hover {
    background: #f8fafc;
}

.duration-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.duration-day {
    background: #fee2e2;
    color: #991b1b;
}

.duration-week {
    background: #fef3c7;
    color: #92400e;
}

.duration-month {
    background: #dcfce7;
    color: #166534;
}

.asset-badge {
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    background: #f3f4f6;
}

.risk-low { color: #059669; }
.risk-medium { color: #d97706; }
.risk-high { color: #dc2626; }

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}

.empty-state i {
    font-size: 48px;
    color: #d1d5db;
    margin-bottom: 16px;
}

@media (max-width: 768px) {
    .filter-section .row {
        gap: 12px;
    }
    
    .date-nav {
        overflow-x: auto;
        padding-bottom: 8px;
    }
    
    .signal-table {
        font-size: 13px;
    }
    
    .summary-card {
        margin-bottom: 12px;
    }
}

#signalDetailModal {
    z-index: 1055 !important;
}

#signalDetailModal .modal-backdrop {
    z-index: 1050 !important;
}

#signalDetailModal .modal-dialog {
    z-index: 1060 !important;
}

#signalDetailModal .modal-content {
    position: relative;
    z-index: 1060 !important;
}

#signalDetailModal .modal-footer {
    border-top: 1px solid #dee2e6;
    padding: 1rem;
}

#signalDetailModal .modal-footer .btn {
    min-width: 100px;
}
</style>
{% endblock %}

{% block dashboard_title %}Daily Signals{% endblock %}
{% block dashboard_subtitle %}Trading signals from our expert analysts{% endblock %}

{% block dashboard_content %}
<div class="container-fluid p-0 daily-signals-page">
    <div class="filter-section">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Select Date</label>
                <input type="date" class="form-control" id="signalDate" 
                       value="{{ selected_date.strftime('%Y-%m-%d') }}"
                       max="{{ date_range[0].strftime('%Y-%m-%d') if date_range else '' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Asset Type</label>
                <select class="form-select" id="assetTypeFilter">
                    <option value="all" {{ 'selected' if asset_type_filter == 'all' else '' }}>All Assets</option>
                    <option value="NIFTY" {{ 'selected' if asset_type_filter == 'NIFTY' else '' }}>Nifty</option>
                    <option value="BANKNIFTY" {{ 'selected' if asset_type_filter == 'BANKNIFTY' else '' }}>BankNifty</option>
                    <option value="SENSEX" {{ 'selected' if asset_type_filter == 'SENSEX' else '' }}>Sensex</option>
                    <option value="FINNIFTY" {{ 'selected' if asset_type_filter == 'FINNIFTY' else '' }}>FinNifty</option>
                    <option value="STOCK" {{ 'selected' if asset_type_filter == 'STOCK' else '' }}>Stocks</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Duration</label>
                <select class="form-select" id="durationFilter">
                    <option value="all" {{ 'selected' if duration_filter == 'all' else '' }}>All Durations</option>
                    <option value="DAY" {{ 'selected' if duration_filter == 'DAY' else '' }}>Day Trading</option>
                    <option value="WEEK" {{ 'selected' if duration_filter == 'WEEK' else '' }}>Swing Trading</option>
                    <option value="MONTH" {{ 'selected' if duration_filter == 'MONTH' else '' }}>Long Term</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="applyFilters()" style="background: #00091a; border-color: #00091a;">
                    <i class="fas fa-filter me-2"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>

    {% if signals %}
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-header py-3 bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0" style="font-size: 16px; font-weight: 600;">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    Trading Signals for {{ selected_date.strftime('%d %B %Y') }}
                </h5>
                <a href="{{ url_for('daily_signals_analysis') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-chart-bar me-1"></i>View Analysis
                </a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="signal-table">
                    <thead>
                        <tr>
                            <th>Asset Type</th>
                            <th>Asset Name</th>
                            <th>Expiry Date</th>
                            <th>Current Price</th>
                            <th>Entry Price</th>
                            <th>Target 1</th>
                            <th>Target 2</th>
                            <th>Stop Loss</th>
                            <th>Duration</th>
                            <th>Risk Level</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for signal in signals %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="asset-badge">{{ signal.asset_type }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold">{{ signal.script }}</div>
                                <small class="text-muted">{{ signal.sub_type_display }}</small>
                            </td>
                            <td>
                                <span class="text-muted">{{ signal.expiry_date.strftime('%d %b %Y') if signal.expiry_date else 'N/A' }}</span>
                            </td>
                            <td>
                                <span class="fw-bold text-primary">₹{{ signal.current_price or '0.00' }}</span>
                            </td>
                            <td>
                                <span class="price-tag entry">₹{{ signal.buy_above }}</span>
                            </td>
                            <td>
                                {% if signal.target_1 %}
                                <span class="price-tag target">₹{{ signal.target_1 }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if signal.target_2 %}
                                <span class="price-tag target">₹{{ signal.target_2 }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="price-tag sl">₹{{ signal.stop_loss }}</span>
                            </td>
                            <td>
                                <span class="duration-badge duration-{{ signal.trade_duration|lower }}">
                                    {{ signal.duration_display }}
                                </span>
                            </td>
                            <td>
                                <span class="fw-bold risk-{{ (signal.risk_level or 'medium')|lower }}">
                                    {{ signal.risk_level or 'Medium' }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewSignalDetail({{ signal.id }})">
                                        View
                                    </button>
                                    <a href="{{ url_for('trade_assist', symbol=signal.symbol, script=signal.script, asset_type=signal.asset_type, sub_type=signal.sub_type, action=signal.action, price=signal.buy_above, stop_loss=signal.stop_loss, target=signal.target_1, target_2=signal.target_2, target_3=signal.target_3, trade_duration=signal.trade_duration, risk_level=signal.risk_level, signal_id=signal.id, source='daily_signals') }}" class="btn btn-sm btn-primary" style="background: #00091a; border-color: #00091a;">
                                        Trade
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-body">
            <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <h5>No Signals Available</h5>
                <p class="text-muted">There are no trading signals for {{ selected_date.strftime('%d %B %Y') }}.</p>
                <p class="text-muted">Check back later or select a different date.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div id="signalDetailSection" class="card border-0 shadow-sm rounded-3 mt-4" style="display: none;">
    <div class="card-header py-3 signal-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-white" id="signalDetailTitle">Signal Details</h5>
        <button type="button" class="btn btn-sm btn-light" onclick="closeSignalDetail()">
            <i class="fas fa-times"></i> Close
        </button>
    </div>
    <div class="card-body" id="signalDetailBody">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const signalData = {
    {% for signal in signals %}
    {{ signal.id }}: {
        id: {{ signal.id }},
        script: "{{ signal.script }}",
        symbol: "{{ signal.symbol }}",
        asset_type: "{{ signal.asset_type }}",
        sub_type: "{{ signal.sub_type or '' }}",
        action: "{{ signal.action }}",
        buy_above: {{ signal.buy_above or 0 }},
        stop_loss: {{ signal.stop_loss or 0 }},
        target_1: {{ signal.target_1 or 'null' }},
        target_2: {{ signal.target_2 or 'null' }},
        target_3: {{ signal.target_3 or 'null' }},
        current_price: {{ signal.current_price or 0 }},
        duration_display: "{{ signal.duration_display }}",
        risk_level: "{{ signal.risk_level or 'Medium' }}",
        notes: "{{ signal.notes or '' }}",
        expiry_date: "{{ signal.expiry_date.strftime('%d %b %Y') if signal.expiry_date else 'N/A' }}"
    },
    {% endfor %}
};

function selectDate(dateStr) {
    document.getElementById('signalDate').value = dateStr;
    applyFilters();
}

function applyFilters() {
    const date = document.getElementById('signalDate').value;
    const assetType = document.getElementById('assetTypeFilter').value;
    const duration = document.getElementById('durationFilter').value;
    
    let url = `{{ url_for('dashboard_daily_signals') }}?date=${date}`;
    if (assetType !== 'all') url += `&asset_type=${assetType}`;
    if (duration !== 'all') url += `&duration=${duration}`;
    
    window.location.href = url;
}

function viewSignalDetail(signalId) {
    const signal = signalData[signalId];
    if (!signal) {
        alert('Signal not found');
        return;
    }
    
    const detailSection = document.getElementById('signalDetailSection');
    const detailTitle = document.getElementById('signalDetailTitle');
    const detailBody = document.getElementById('signalDetailBody');
    
    detailTitle.textContent = signal.script;
    
    const potentialReturn = signal.target_1 && signal.buy_above ? (((signal.target_1 - signal.buy_above) / signal.buy_above) * 100) : 0;
    const riskPct = signal.stop_loss && signal.buy_above ? (((signal.buy_above - signal.stop_loss) / signal.buy_above) * 100) : 0;
    const riskReward = riskPct > 0 ? (potentialReturn / riskPct) : 0;
    
    detailBody.innerHTML = `
        <div class="row g-4">
            <div class="col-md-6">
                <div class="p-4 bg-light rounded-3">
                    <h6 class="text-muted mb-3">Signal Details</h6>
                    <div class="mb-3">
                        <small class="text-muted">Action</small>
                        <div class="badge ${signal.action === 'BUY' ? 'bg-success' : 'bg-danger'} fs-6">${signal.action}</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Asset Type</small>
                        <div class="fw-bold">${signal.asset_type}${signal.sub_type ? ' - ' + signal.sub_type : ''}</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Expiry Date</small>
                        <div class="fw-bold">${signal.expiry_date}</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Duration</small>
                        <div class="fw-bold">${signal.duration_display}</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Risk Level</small>
                        <div class="fw-bold risk-${signal.risk_level.toLowerCase()}">${signal.risk_level}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="p-4 bg-light rounded-3">
                    <h6 class="text-muted mb-3">Price Levels</h6>
                    <div class="mb-3">
                        <small class="text-muted">Current Price</small>
                        <div class="fw-bold text-primary fs-5">₹${signal.current_price.toFixed(2)}</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Entry Price</small>
                        <div class="price-tag entry">
                            <i class="fas fa-arrow-right"></i> ₹${signal.buy_above}
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Stop Loss</small>
                        <div class="price-tag sl">
                            <i class="fas fa-shield-alt"></i> ₹${signal.stop_loss}
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Targets</small>
                        <div class="target-list">
                            ${signal.target_1 ? `<span class="price-tag target">T1: ₹${signal.target_1}</span>` : ''}
                            ${signal.target_2 ? `<span class="price-tag target">T2: ₹${signal.target_2}</span>` : ''}
                            ${signal.target_3 ? `<span class="price-tag target">T3: ₹${signal.target_3}</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="p-4 border rounded-3">
                    <h6 class="text-muted mb-3">Risk/Reward Analysis</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="fs-4 fw-bold ${potentialReturn > 0 ? 'text-success' : ''}">${potentialReturn.toFixed(1)}%</div>
                            <small class="text-muted">Potential Return</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold text-danger">${riskPct.toFixed(1)}%</div>
                            <small class="text-muted">Risk</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold">${riskReward.toFixed(2)}</div>
                            <small class="text-muted">Risk:Reward</small>
                        </div>
                    </div>
                </div>
            </div>
            ${signal.notes ? `
            <div class="col-12">
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Analyst Notes:</strong> ${signal.notes}
                </div>
            </div>
            ` : ''}
            <div class="col-12">
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Disclaimer:</strong> Trading involves risk. Please use the signals responsibly and at your own discretion. Place SL-Limit Order to avoid slippage and fast movement.
                </div>
            </div>
        </div>
    `;
    
    detailSection.style.display = 'block';
    detailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function closeSignalDetail() {
    document.getElementById('signalDetailSection').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('signalDate').addEventListener('change', function() {
        applyFilters();
    });
});
</script>
{% endblock %}
