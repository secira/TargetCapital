{% extends "dashboard/dashboard_base.html" %}

{% block title %}Equities - Target Capital{% endblock %}
{% block dashboard_title %}Equities Portfolio{% endblock %}
{% block dashboard_subtitle %}Manage your equity holdings from brokers or manual entries{% endblock %}

{% block dashboard_toolbar %}
<div class="header-actions">
    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addEquityModal">
        <i class="fas fa-plus me-1"></i>Add Equity
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
        <i class="fas fa-sync me-1"></i>Refresh
    </button>
</div>
{% endblock %}

{% block dashboard_content %}
<div class="row">
    <!-- Holdings Summary -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Total Investment</h6>
                <h3 class="mb-0">₹{{ "{:,.0f}".format(total_investment) if total_investment else '0' }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Current Value</h6>
                <h3 class="mb-0">₹{{ "{:,.0f}".format(current_value) if current_value else '0' }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Total P&L</h6>
                <h3 class="mb-0 {% if total_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ₹{{ "{:,.0f}".format(total_pnl) if total_pnl else '0' }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-2">Holdings</h6>
                <h3 class="mb-0">{{ holdings_count }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Holdings Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Equity Holdings</h5>
        <div class="btn-group btn-group-sm" role="group">
            <input type="radio" class="btn-check" name="viewType" id="manualView" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="manualView" onclick="filterHoldings('manual')">Manual</label>
            
            <input type="radio" class="btn-check" name="viewType" id="brokerView" autocomplete="off">
            <label class="btn btn-outline-primary" for="brokerView" onclick="filterHoldings('broker')">Broker</label>
            
            <input type="radio" class="btn-check" name="viewType" id="allView" autocomplete="off">
            <label class="btn btn-outline-primary" for="allView" onclick="filterHoldings('all')">All</label>
        </div>
    </div>
    <div class="card-body">
        {% if holdings %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Company</th>
                        <th>Quantity</th>
                        <th>Purchase Price</th>
                        <th>Current Price</th>
                        <th>Investment</th>
                        <th>Current Value</th>
                        <th>P&L</th>
                        <th>P&L %</th>
                        <th>Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="holdingsTable">
                    {% for holding in holdings %}
                    <tr class="holding-row" data-source="{{ 'manual' if holding.source == 'manual' else 'broker' }}">
                        <td><strong>{{ holding.symbol }}</strong></td>
                        <td>{{ holding.company_name }}</td>
                        <td>{{ holding.quantity }}</td>
                        <td>₹{{ "{:,.2f}".format(holding.purchase_price) }}</td>
                        <td>₹{{ "{:,.2f}".format(holding.current_price) if holding.current_price else '-' }}</td>
                        <td>₹{{ "{:,.0f}".format(holding.total_investment) }}</td>
                        <td>₹{{ "{:,.0f}".format(holding.current_value) if holding.current_value else '-' }}</td>
                        <td class="{% if holding.unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if holding.unrealized_pnl %}
                            ₹{{ "{:,.0f}".format(holding.unrealized_pnl) }}
                            {% else %}-{% endif %}
                        </td>
                        <td class="{% if holding.unrealized_pnl_percentage >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if holding.unrealized_pnl_percentage %}
                            {{ "{:,.2f}".format(holding.unrealized_pnl_percentage) }}%
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if holding.source == 'manual' %}
                            <span class="badge bg-info">Manual</span>
                            {% else %}
                            <span class="badge bg-primary">Broker</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if holding.source == 'manual' %}
                            <button class="btn btn-sm btn-outline-primary" onclick="editHolding({{ holding.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteHolding({{ holding.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <p class="text-muted">No equity holdings found. Add your first equity holding!</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEquityModal">
                <i class="fas fa-plus me-2"></i>Add Equity
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Equity Modal -->
<div class="modal fade" id="addEquityModal" tabindex="-1" aria-labelledby="addEquityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEquityModalLabel">Add Equity Holding</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('dashboard_equities') }}">
                <div class="modal-body">
                    <div class="row">
                        <!-- Stock Details -->
                        <div class="col-md-6 mb-3">
                            <label for="symbol" class="form-label">Stock Symbol <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="symbol" name="symbol" required placeholder="e.g., RELIANCE">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company_name" name="company_name" placeholder="e.g., Reliance Industries Ltd">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="isin" class="form-label">ISIN</label>
                            <input type="text" class="form-control" id="isin" name="isin" placeholder="e.g., INE002A01018">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="transaction_type" class="form-label">Transaction Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="transaction_type" name="transaction_type" required>
                                <option value="BUY" selected>BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        
                        <!-- Transaction Details -->
                        <div class="col-md-6 mb-3">
                            <label for="purchase_date" class="form-label">Purchase Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="purchase_date" name="purchase_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quantity" name="quantity" step="0.01" required placeholder="100">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="purchase_price" class="form-label">Purchase Price (₹) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="purchase_price" name="purchase_price" step="0.01" required placeholder="2500.00">
                        </div>
                        
                        <!-- Charges (Optional) -->
                        <div class="col-12 mb-2">
                            <h6 class="text-muted">Transaction Charges (Optional)</h6>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="brokerage" class="form-label">Brokerage (₹)</label>
                            <input type="number" class="form-control" id="brokerage" name="brokerage" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="stt" class="form-label">STT (₹)</label>
                            <input type="number" class="form-control" id="stt" name="stt" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="transaction_charges" class="form-label">Transaction Charges (₹)</label>
                            <input type="number" class="form-control" id="transaction_charges" name="transaction_charges" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="gst" class="form-label">GST (₹)</label>
                            <input type="number" class="form-control" id="gst" name="gst" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="stamp_duty" class="form-label">Stamp Duty (₹)</label>
                            <input type="number" class="form-control" id="stamp_duty" name="stamp_duty" step="0.01" placeholder="0.00">
                        </div>
                        
                        <!-- Additional Info -->
                        <div class="col-md-6 mb-3">
                            <label for="portfolio_name" class="form-label">Portfolio Name</label>
                            <input type="text" class="form-control" id="portfolio_name" name="portfolio_name" value="Default" placeholder="Default">
                        </div>
                        <div class="col-12 mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Any additional notes..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Equity
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Ensure modal appears on top with proper z-index */
#addEquityModal {
    z-index: 1060 !important;
}

#addEquityModal .modal-dialog {
    z-index: 1061 !important;
}

.modal-backdrop {
    z-index: 1055 !important;
}

/* Ensure modal is scrollable on smaller screens */
#addEquityModal .modal-body {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
}
</style>

<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Set max date to today
    const purchaseDateInput = document.getElementById('purchase_date');
    if (purchaseDateInput) {
        purchaseDateInput.max = new Date().toISOString().split('T')[0];
    }
    
    // Ensure modal works properly
    const addEquityModal = document.getElementById('addEquityModal');
    if (addEquityModal) {
        addEquityModal.addEventListener('shown.bs.modal', function () {
            // Focus on first input when modal opens
            const firstInput = addEquityModal.querySelector('input[type="text"]');
            if (firstInput) {
                firstInput.focus();
            }
        });
    }
});

function filterHoldings(type) {
    const rows = document.querySelectorAll('.holding-row');
    rows.forEach(row => {
        if (type === 'all') {
            row.style.display = '';
        } else {
            row.style.display = row.dataset.source === type ? '' : 'none';
        }
    });
}

function editHolding(id) {
    alert('Edit functionality coming soon!');
}

function deleteHolding(id) {
    if (confirm('Are you sure you want to delete this holding?')) {
        fetch(`/api/equities/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting holding: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}
