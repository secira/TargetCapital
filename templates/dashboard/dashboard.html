{% extends "dashboard/dashboard_base.html" %}

{% block dashboard_title %}Dashboard{% endblock %}
{% block dashboard_subtitle %}Your AI-powered trading command center{% endblock %}

{% block dashboard_toolbar %}
<div class="header-actions">
    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshDashboard()">
        <i class="fas fa-sync-alt me-1"></i>
        Refresh
    </button>
    <div class="dropdown">
        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-plus me-1"></i>
            Quick Actions
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('dashboard_stock_picker') }}">
                <i class="fas fa-robot me-2"></i>AI Stock Picker
            </a></li>
            {% if current_user.is_authenticated and current_user.can_access_menu('dashboard_trade_now') %}
            <li><a class="dropdown-item" href="{{ url_for('dashboard_trade_now') }}">
                <i class="fas fa-exchange-alt me-2"></i>Start Trading
            </a></li>
            {% endif %}
        </ul>
    </div>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Portfolio Overview Cards -->
<div class="dashboard-grid cols-4">
    <!-- Total Portfolio Value -->
    <div class="dashboard-card">
        <div class="card-body">
            <div class="flex-between mb-3">
                <div class="metric-icon">
                    <i class="fas fa-wallet text-primary"></i>
                </div>
                <div class="metric-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12.5%</span>
                </div>
            </div>
            <h3 class="metric-value">₹2,45,680</h3>
            <p class="metric-label">Total Portfolio Value</p>
            <div class="metric-trend">
                <small class="text-muted">+₹27,180 this month</small>
            </div>
        </div>
    </div>

    <!-- AI Trading Signals -->
    <div class="dashboard-card">
        <div class="card-body">
            <div class="flex-between mb-3">
                <div class="metric-icon">
                    <i class="fas fa-chart-line text-success"></i>
                </div>
                <div class="metric-badge">
                    <span class="badge bg-success">Live</span>
                </div>
            </div>
            <h3 class="metric-value">18</h3>
            <p class="metric-label">Active Signals</p>
            <div class="metric-trend">
                <small class="text-muted">3 new signals today</small>
            </div>
        </div>
    </div>

    <!-- Active Strategies -->
    <div class="dashboard-card">
        <div class="card-body">
            <div class="flex-between mb-3">
                <div class="metric-icon">
                    <i class="fas fa-cogs text-warning"></i>
                </div>
                <div class="metric-change neutral">
                    <i class="fas fa-minus"></i>
                    <span>Stable</span>
                </div>
            </div>
            <h3 class="metric-value">5</h3>
            <p class="metric-label">Active Strategies</p>
            <div class="metric-trend">
                <small class="text-muted">2 performing well</small>
            </div>
        </div>
    </div>

    <!-- Account Status -->
    <div class="dashboard-card">
        <div class="card-body">
            <div class="flex-between mb-3">
                <div class="metric-icon">
                    <i class="fas fa-user-check text-info"></i>
                </div>
                <div class="metric-status">
                    <div class="status-dot active"></div>
                </div>
            </div>
            <h3 class="metric-value">{{ broker_accounts|length }}</h3>
            <p class="metric-label">Connected Brokers</p>
            <div class="metric-trend">
                <small class="text-muted">All systems operational</small>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Content -->
<div class="dashboard-grid cols-3">
    <!-- Market Overview -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>Market Overview</h3>
            <span class="update-time">Last updated: 2 mins ago</span>
        </div>
        <div class="card-body">
            <div class="market-indices">
                <div class="index-item">
                    <div class="index-info">
                        <span class="index-name">NIFTY 50</span>
                        <span class="index-value">21,894.50</span>
                    </div>
                    <div class="index-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+156.30 (+0.72%)</span>
                    </div>
                </div>
                <div class="index-item">
                    <div class="index-info">
                        <span class="index-name">SENSEX</span>
                        <span class="index-value">72,240.26</span>
                    </div>
                    <div class="index-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+485.90 (+0.68%)</span>
                    </div>
                </div>
                <div class="index-item">
                    <div class="index-info">
                        <span class="index-name">NIFTY BANK</span>
                        <span class="index-value">47,325.80</span>
                    </div>
                    <div class="index-change negative">
                        <i class="fas fa-arrow-down"></i>
                        <span>-123.45 (-0.26%)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Holdings -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>Top Holdings</h3>
            <a href="{{ url_for('dashboard_my_portfolio') if current_user.can_access_menu('dashboard_my_portfolio') else '#' }}" class="view-all">
                View All
            </a>
        </div>
        <div class="card-body">
            <div class="holdings-list">
                <div class="holding-item">
                    <div class="holding-info">
                        <span class="stock-symbol">RELIANCE</span>
                        <span class="stock-name">Reliance Industries</span>
                    </div>
                    <div class="holding-metrics">
                        <span class="holding-value">₹45,680</span>
                        <span class="holding-change positive">+2.4%</span>
                    </div>
                </div>
                <div class="holding-item">
                    <div class="holding-info">
                        <span class="stock-symbol">TCS</span>
                        <span class="stock-name">Tata Consultancy Services</span>
                    </div>
                    <div class="holding-metrics">
                        <span class="holding-value">₹38,240</span>
                        <span class="holding-change positive">+1.8%</span>
                    </div>
                </div>
                <div class="holding-item">
                    <div class="holding-info">
                        <span class="stock-symbol">INFY</span>
                        <span class="stock-name">Infosys Limited</span>
                    </div>
                    <div class="holding-metrics">
                        <span class="holding-value">₹29,850</span>
                        <span class="holding-change negative">-0.9%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>AI Market Intelligence</h3>
            <div class="ai-status-indicator">
                <div class="status-dot active"></div>
                <span>Live Analysis</span>
            </div>
        </div>
        <div class="card-body">
            <div class="ai-insights">
                <div class="insight-item">
                    <div class="insight-icon">
                        <i class="fas fa-lightbulb text-warning"></i>
                    </div>
                    <div class="insight-content">
                        <p class="insight-text">Banking sector showing strong momentum. Consider HDFC Bank for long-term growth.</p>
                        <span class="insight-confidence">Confidence: 87%</span>
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                    </div>
                    <div class="insight-content">
                        <p class="insight-text">Technology stocks may face volatility due to global market conditions.</p>
                        <span class="insight-confidence">Confidence: 92%</span>
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon">
                        <i class="fas fa-chart-line text-success"></i>
                    </div>
                    <div class="insight-content">
                        <p class="insight-text">Pharmaceutical sector expected to outperform in Q4. High growth potential.</p>
                        <span class="insight-confidence">Confidence: 89%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Chart -->
<div class="dashboard-grid cols-2">
    <!-- Portfolio Performance Chart -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>Portfolio Performance</h3>
            <div class="chart-controls">
                <button class="btn btn-sm btn-outline-secondary active">1M</button>
                <button class="btn btn-sm btn-outline-secondary">3M</button>
                <button class="btn btn-sm btn-outline-secondary">1Y</button>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="portfolioChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>Recent Activity</h3>
            <a href="#" class="view-all">View All</a>
        </div>
        <div class="card-body">
            <div class="activity-feed">
                <div class="activity-item">
                    <div class="activity-icon buy">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="activity-content">
                        <p class="activity-text">Bought 50 shares of <strong>RELIANCE</strong></p>
                        <span class="activity-time">2 hours ago</span>
                    </div>
                    <div class="activity-amount positive">+₹12,450</div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon sell">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="activity-content">
                        <p class="activity-text">Sold 25 shares of <strong>WIPRO</strong></p>
                        <span class="activity-time">5 hours ago</span>
                    </div>
                    <div class="activity-amount negative">-₹8,970</div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon signal">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="activity-content">
                        <p class="activity-text">AI Signal: <strong>BUY</strong> recommendation for TCS</p>
                        <span class="activity-time">1 day ago</span>
                    </div>
                    <div class="activity-confidence">95% confidence</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard Refresh Function
function refreshDashboard() {
    const refreshBtn = document.querySelector('[onclick="refreshDashboard()"]');
    const icon = refreshBtn.querySelector('i');
    
    // Add loading state
    icon.classList.add('fa-spin');
    refreshBtn.disabled = true;
    
    // Simulate refresh (replace with actual API call)
    setTimeout(() => {
        icon.classList.remove('fa-spin');
        refreshBtn.disabled = false;
        
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'toast-notification success';
        toast.textContent = 'Dashboard refreshed successfully';
        document.body.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    }, 1500);
}

// Portfolio Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('portfolioChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Portfolio Value',
                    data: [210000, 225000, 218000, 235000, 245000, 245680],
                    borderColor: '#4299e1',
                    backgroundColor: 'rgba(66, 153, 225, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
});
</script>

<style>
/* Dashboard Specific Styles */
.metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: rgba(66, 153, 225, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.metric-icon i {
    font-size: 20px;
}

.metric-change {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 12px;
}

.metric-change.positive {
    background: rgba(72, 187, 120, 0.1);
    color: #48bb78;
}

.metric-change.negative {
    background: rgba(245, 101, 101, 0.1);
    color: #f56565;
}

.metric-change.neutral {
    background: rgba(160, 174, 192, 0.1);
    color: #a0aec0;
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: #1a202c;
    margin: 8px 0 4px 0;
}

.metric-label {
    font-size: 14px;
    color: #718096;
    margin: 0;
    font-weight: 500;
}

.metric-trend {
    margin-top: 8px;
}

.metric-badge {
    display: flex;
    align-items: center;
}

.metric-status {
    display: flex;
    align-items: center;
}

.update-time {
    font-size: 12px;
    color: #a0aec0;
}

.view-all {
    font-size: 14px;
    color: #4299e1;
    text-decoration: none;
    font-weight: 500;
}

.view-all:hover {
    color: #3182ce;
}

/* Market Indices */
.market-indices {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.index-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e2e8f0;
}

.index-item:last-child {
    border-bottom: none;
}

.index-info {
    display: flex;
    flex-direction: column;
}

.index-name {
    font-size: 14px;
    font-weight: 600;
    color: #2d3748;
}

.index-value {
    font-size: 16px;
    font-weight: 700;
    color: #1a202c;
}

.index-change {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    font-weight: 600;
}

.index-change.positive {
    color: #48bb78;
}

.index-change.negative {
    color: #f56565;
}

/* Holdings */
.holdings-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.holding-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.holding-info {
    display: flex;
    flex-direction: column;
}

.stock-symbol {
    font-size: 14px;
    font-weight: 700;
    color: #2d3748;
}

.stock-name {
    font-size: 12px;
    color: #718096;
}

.holding-metrics {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.holding-value {
    font-size: 14px;
    font-weight: 600;
    color: #1a202c;
}

.holding-change {
    font-size: 12px;
    font-weight: 600;
}

.holding-change.positive {
    color: #48bb78;
}

.holding-change.negative {
    color: #f56565;
}

/* AI Insights */
.ai-status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #48bb78;
    font-weight: 500;
}

.ai-insights {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.insight-item {
    display: flex;
    gap: 12px;
}

.insight-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: rgba(66, 153, 225, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.insight-content {
    flex: 1;
}

.insight-text {
    font-size: 13px;
    color: #2d3748;
    margin: 0 0 4px 0;
    line-height: 1.4;
}

.insight-confidence {
    font-size: 11px;
    color: #718096;
    font-weight: 500;
}

/* Activity Feed */
.activity-feed {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 12px;
}

.activity-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.activity-icon.buy {
    background: rgba(72, 187, 120, 0.1);
    color: #48bb78;
}

.activity-icon.sell {
    background: rgba(245, 101, 101, 0.1);
    color: #f56565;
}

.activity-icon.signal {
    background: rgba(66, 153, 225, 0.1);
    color: #4299e1;
}

.activity-content {
    flex: 1;
}

.activity-text {
    font-size: 13px;
    color: #2d3748;
    margin: 0 0 2px 0;
}

.activity-time {
    font-size: 11px;
    color: #a0aec0;
}

.activity-amount {
    font-size: 13px;
    font-weight: 600;
}

.activity-amount.positive {
    color: #48bb78;
}

.activity-amount.negative {
    color: #f56565;
}

.activity-confidence {
    font-size: 11px;
    color: #4299e1;
    font-weight: 500;
}

/* Chart Container */
.chart-container {
    height: 200px;
    position: relative;
}

.chart-controls {
    display: flex;
    gap: 4px;
}

.chart-controls .btn {
    padding: 4px 12px;
    font-size: 12px;
}

/* Toast Notifications */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4299e1;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1060;
    animation: slideIn 0.3s ease;
}

.toast-notification.success {
    background: #48bb78;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .dashboard-grid.cols-4 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-grid.cols-3,
    .dashboard-grid.cols-2 {
        grid-template-columns: 1fr;
    }
    
    .metric-value {
        font-size: 24px;
    }
    
    .header-actions {
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }
    
    .header-actions .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .dashboard-grid.cols-4 {
        grid-template-columns: 1fr;
    }
    
    .metric-icon {
        width: 40px;
        height: 40px;
    }
    
    .metric-value {
        font-size: 20px;
    }
}
</style>
{% endblock %}