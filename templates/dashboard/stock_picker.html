{% extends "base.html" %}

{% block title %}Stock Picker - tCapital Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0">
            {% include 'dashboard/sidebar.html' %}
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="fas fa-search me-2"></i>AI Stock Picker</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-primary btn-sm" onclick="generateAIRecommendations()">
                            <i class="fas fa-robot me-1"></i>Generate AI Picks
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Research Controls -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-brain me-2"></i>AI Research Engine</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Research Type</label>
                                        <select class="form-select" id="researchType">
                                            <option value="recommendations">Stock Recommendations</option>
                                            <option value="single">Single Stock Analysis</option>
                                            <option value="sector">Sector Analysis</option>
                                            <option value="market">Market Overview</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Investment Strategy</label>
                                        <select class="form-select" id="investmentStrategy">
                                            <option value="growth">Growth Investing</option>
                                            <option value="value">Value Investing</option>
                                            <option value="momentum">Momentum Trading</option>
                                            <option value="dividend">Dividend Investing</option>
                                            <option value="mixed">Mixed Strategy</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Risk Tolerance</label>
                                        <select class="form-select" id="riskTolerance">
                                            <option value="low">Conservative (Low Risk)</option>
                                            <option value="medium">Moderate (Medium Risk)</option>
                                            <option value="high">Aggressive (High Risk)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Investment Horizon</label>
                                        <select class="form-select" id="investmentHorizon">
                                            <option value="short">Short Term (1-6 months)</option>
                                            <option value="medium">Medium Term (6-18 months)</option>
                                            <option value="long">Long Term (1+ years)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="singleStockRow" style="display: none;">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Stock Symbol</label>
                                        <input type="text" class="form-control" id="stockSymbol" placeholder="Enter stock symbol (e.g., RELIANCE)">
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="startAIResearch()">
                                <i class="fas fa-play me-2"></i>Start AI Research
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Research Loading -->
            <div class="row mb-4" id="researchLoading" style="display: none;">
                <div class="col-md-12">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Researching...</span>
                            </div>
                            <h5 class="mt-3">AI is analyzing market data...</h5>
                            <p class="text-muted">Using advanced algorithms to identify the best investment opportunities</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Research Results -->
            <div class="row" id="researchResults" style="display: none;">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>AI Research Results</h5>
                            <span class="badge bg-success">Generated by Agentic AI</span>
                        </div>
                        <div class="card-body" id="researchResultsBody">
                            <!-- Results will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Top AI Picks Section -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-star me-2"></i>Today's Top AI Picks</h5>
                            <div class="d-flex align-items-center gap-2">
                                <input type="date" class="form-control form-control-sm" id="picksDate" value="{{ today.strftime('%Y-%m-%d') }}" onchange="loadAIPicksForDate(this.value)">
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshAIPicks()">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if ai_picks %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Company</th>
                                            <th>Current Price</th>
                                            <th>Target Price</th>
                                            <th>Recommendation</th>
                                            <th>Confidence</th>
                                            <th>Sector</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for pick in ai_picks %}
                                        <tr>
                                            <td><strong>{{ pick.symbol }}</strong></td>
                                            <td>{{ pick.company_name }}</td>
                                            <td>₹{{ "%.2f"|format(pick.current_price) }}</td>
                                            <td>
                                                {% if pick.target_price %}
                                                ₹{{ "%.2f"|format(pick.target_price) }}
                                                {% set upside = ((pick.target_price - pick.current_price) / pick.current_price * 100) %}
                                                <small class="{% if upside > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    ({{ "%.1f"|format(upside) }}%)
                                                </small>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge {% if pick.recommendation == 'BUY' %}bg-success{% elif pick.recommendation == 'SELL' %}bg-danger{% else %}bg-warning{% endif %}">
                                                    {{ pick.recommendation }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px; width: 60px;">
                                                    <div class="progress-bar {% if pick.confidence_score >= 80 %}bg-success{% elif pick.confidence_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         style="width: {{ pick.confidence_score }}%">
                                                        {{ pick.confidence_score }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge bg-light text-dark">{{ pick.sector }}</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewDetailedAnalysis('{{ pick.symbol }}')">
                                                    <i class="fas fa-chart-bar"></i> Analysis
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" onclick="addToWatchlist('{{ pick.symbol }}')">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No AI picks available for {{ selected_date or 'today' }}</h5>
                                <p class="text-muted">AI is analyzing market data to generate personalized stock recommendations.</p>
                                <button class="btn btn-primary" onclick="generateAIPicksForDate()">
                                    <i class="fas fa-magic me-2"></i>Generate AI Picks
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>



            <!-- AI Insights Summary -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-thumbs-up me-2"></i>Market Opportunities</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Energy sector showing strong momentum</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>IT stocks at attractive valuations</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Banking sector consolidation benefits</li>
                                <li class="mb-0"><i class="fas fa-check text-success me-2"></i>Infrastructure spending boost expected</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Risk Factors</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2"><i class="fas fa-exclamation text-danger me-2"></i>Global inflation concerns</li>
                                <li class="mb-2"><i class="fas fa-exclamation text-danger me-2"></i>Regulatory changes in fintech</li>
                                <li class="mb-2"><i class="fas fa-exclamation text-danger me-2"></i>Currency volatility impact</li>
                                <li class="mb-0"><i class="fas fa-exclamation text-danger me-2"></i>Geopolitical tensions</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis Modal -->
<div class="modal fade" id="detailedAnalysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detailed Stock Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailedAnalysisBody">
                <!-- Detailed analysis will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
// Show/hide single stock input based on research type
document.getElementById('researchType').addEventListener('change', function() {
    const singleStockRow = document.getElementById('singleStockRow');
    if (this.value === 'single') {
        singleStockRow.style.display = 'block';
    } else {
        singleStockRow.style.display = 'none';
    }
});

function generateAIRecommendations() {
    console.log('Generating AI recommendations...');
    // TODO: Implement AI recommendation generation
}

function startAIResearch() {
    const researchType = document.getElementById('researchType').value;
    const strategy = document.getElementById('investmentStrategy').value;
    const risk = document.getElementById('riskTolerance').value;
    const horizon = document.getElementById('investmentHorizon').value;
    
    // Handle single stock analysis
    if (researchType === 'single') {
        const stockSymbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
        if (!stockSymbol) {
            alert('Please enter a stock symbol');
            return;
        }
        // Navigate to detailed analysis page for the entered stock
        window.location.href = `/dashboard/detailed-analysis/${stockSymbol}`;
        return;
    }
    
    // Show loading
    document.getElementById('researchLoading').style.display = 'block';
    document.getElementById('researchResults').style.display = 'none';
    
    // Simulate AI research process
    setTimeout(() => {
        document.getElementById('researchLoading').style.display = 'none';
        document.getElementById('researchResults').style.display = 'block';
        
        // Display mock results
        document.getElementById('researchResultsBody').innerHTML = `
            <div class="row">
                <div class="col-md-12">
                    <h6>Research Summary</h6>
                    <p>Based on your ${strategy} strategy with ${risk} risk tolerance for ${horizon} investment horizon, our AI has identified the following opportunities:</p>
                    
                    <div class="alert alert-info">
                        <strong>AI Insight:</strong> Current market conditions favor ${strategy} approach with emphasis on fundamentally strong companies in growth sectors.
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h5 class="text-primary">12</h5>
                                <p class="mb-0">Stocks Analyzed</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h5 class="text-success">5</h5>
                                <p class="mb-0">Strong Buys</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h5 class="text-warning">3</h5>
                                <p class="mb-0">Watch List</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }, 3000);
}

function viewDetailedAnalysis(symbol) {
    // Navigate to detailed analysis page instead of modal
    window.location.href = `/dashboard/detailed-analysis/${symbol}`;
}

function generateAIPicksForDate() {
    alert('Generating AI picks for the selected date...');
}

function loadAIPicksForDate(date) {
    window.location.href = `{{ url_for('dashboard_stock_picker') }}?date=${date}`;
}

function refreshAIPicks() {
    location.reload();
}

function addToWatchlist(symbol) {
    // Implementation to add to watchlist
    alert('Adding ' + symbol + ' to watchlist...');
}

function generateAIRecommendations() {
    console.log('Generating AI recommendations...');
    alert('AI recommendations are being generated based on market analysis...');
}
</script>

<style>
.card {
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.progress {
    border-radius: 10px;
}

.badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.6rem;
}

.btn-toolbar .btn-group {
    margin-right: 0.5rem;
}

.border-success .card-body, .border-info .card-body, .border-warning .card-body {
    border-left: 4px solid;
}

.border-success .card-body {
    border-left-color: #28a745;
}

.border-info .card-body {
    border-left-color: #17a2b8;
}

.border-warning .card-body {
    border-left-color: #ffc107;
}
</style>
{% endblock %}