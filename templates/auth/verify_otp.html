{% extends "base.html" %}

{% block title %}Verify OTP - Target Capital{% endblock %}

{% block content %}
<section class="bg-white text-dark" style="padding-top: 120px; min-height: 100vh;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <div class="mb-3">
                                <i class="fas fa-mobile-alt fa-3x text-primary"></i>
                            </div>
                            <h2 class="fw-bold text-primary">Verify OTP</h2>
                            <p class="text-muted">Enter the OTP sent to your mobile ending with <strong>****{{ mobile_number }}</strong></p>
                        </div>

                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <form method="POST" action="{{ url_for('verify_mobile_otp') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-4">
                                <label for="otp" class="form-label">Enter OTP</label>
                                <input type="text" class="form-control text-center" id="otp" name="otp" 
                                       required placeholder="Enter 6-digit OTP" maxlength="6" 
                                       pattern="[0-9]{6}" style="font-size: 1.5rem; letter-spacing: 0.5rem;">
                                <div class="form-text">OTP is valid for 10 minutes</div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 py-3 mb-3">
                                <i class="fas fa-check-circle me-2"></i>Verify OTP
                            </button>
                        </form>
                        
                        <!-- Resend OTP -->
                        <div class="text-center">
                            <p class="mb-2">Didn't receive the OTP?</p>
                            <button id="resendBtn" class="btn btn-outline-primary" onclick="resendOTP()">
                                <i class="fas fa-redo me-2"></i>Resend OTP
                            </button>
                            <div id="resendCooldown" class="mt-2" style="display: none;">
                                <small class="text-muted">Please wait <span id="countdown">60</span> seconds before resending</small>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <a href="{{ url_for('mobile_register') }}" class="text-muted text-decoration-none">
                                <i class="fas fa-arrow-left me-1"></i>Back to mobile registration
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Auto-focus and format OTP input
document.getElementById('otp').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, ''); // Remove non-digits
    this.value = value;
});

// Resend OTP functionality
function resendOTP() {
    const resendBtn = document.getElementById('resendBtn');
    const resendCooldown = document.getElementById('resendCooldown');
    const countdown = document.getElementById('countdown');
    
    // Disable button and show cooldown
    resendBtn.disabled = true;
    resendBtn.style.display = 'none';
    resendCooldown.style.display = 'block';
    
    // Send request
    fetch('{{ url_for("resend_otp") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('form'));
        } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('form'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
    
    // Start countdown
    let timeLeft = 60;
    const timer = setInterval(() => {
        timeLeft--;
        countdown.textContent = timeLeft;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            resendBtn.disabled = false;
            resendBtn.style.display = 'inline-block';
            resendCooldown.style.display = 'none';
        }
    }, 1000);
}

// Auto-submit when 6 digits entered
document.getElementById('otp').addEventListener('input', function() {
    if (this.value.length === 6) {
        // Small delay to allow user to see the complete OTP
        setTimeout(() => {
            if (this.value.length === 6) {
                this.form.submit();
            }
        }, 500);
    }
});
</script>
{% endblock %}